<html lang="pt-BR"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Minhas Notas</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Minhas Notas">
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
 
    <style>
        :root {
            --bg-primary: #f0f2f5; --bg-secondary: #ffffff; --bg-tertiary: #ffffff;
            --text-dark: #1d1d1f; --text-light: #6e6e73; --border-color: #d1d1d6;
            --accent-color: #007aff; --accent-color-hover: #0056b3; --button-success: #34c759;
            --button-danger: #ff3b30; --button-whatsapp: #25d366; --radius: 16px;
            --shadow: rgba(0, 0, 0, 0.05); --transition-swift: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        body.dark-mode {
            --bg-primary: #000000; --bg-secondary: #1c1c1e; --bg-tertiary: #2c2c2e;
            --text-dark: #ffffff; --text-light: #8e8e93; --border-color: #3a3a3c;
            --shadow: rgba(255, 255, 255, 0.08);
        }
        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-dark); -webkit-user-select: none; user-select: none; }
         
        /* --- ESTILOS DA TELA DE LOGIN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            flex-direction: column; padding: 24px;
        }
        .login-box {
            width: 100%; max-width: 320px; text-align: center;
        }
        .login-box .icon { font-size: 48px; color: var(--text-light); margin-bottom: 24px; transition: color 0.4s ease, transform 0.4s ease; }
        .login-box .icon.unlocked { color: var(--button-success); transform: rotate(-10deg); }
        .login-box h1 { font-size: 24px; color: var(--text-dark); margin-bottom: 8px; font-weight: 700; }
        .login-box p { font-size: 16px; color: var(--text-light); margin-bottom: 24px; }
        .login-box input { text-align: center; font-size: 18px; }
        .login-box button { margin-top: 16px; background-color: var(--accent-color); }
        .login-box .error-message { color: var(--button-danger); font-size: 14px; height: 20px; margin-top: 8px; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        .shake { animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both; }


        .app-container { position: relative; width: 100%; height: 100vh; max-width: 680px; margin: 0 auto; background-color: var(--bg-primary); overflow: hidden; display: none; /* Inicia oculto */ flex-direction: column; }
        .main-content { flex-grow: 1; position: relative; overflow: hidden; }
 
        .app-screen, .modal-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-primary); visibility: hidden;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1), visibility 0s linear 0.35s;
            z-index: 1; display: flex; flex-direction: column; opacity: 0;
            transform: translateY(15px);
        }
        .app-screen.active, .modal-screen.active {
            visibility: visible; z-index: 2; transform: translateY(0); opacity: 1;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-screen { z-index: 1000; position: fixed; max-width: 680px; margin: 0 auto; }
         
        .screen-content { padding: 24px; overflow-y: auto; flex-grow: 1; }
        .header { padding: 16px 24px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); box-shadow: 0 1px 2px var(--shadow); }
        .header-title { font-size: 28px; font-weight: 700; color: var(--text-dark); margin: 0; }
        .header-action { background: none; border: none; color: var(--text-light); font-size: 20px; cursor: pointer; padding: 8px; display: flex; align-items: center; gap: 8px; }
 
        .modal-screen .header-title { font-size: 18px; font-weight: 600; }
        .modal-screen .close-modal { font-size: 28px; font-weight: 400; color: var(--text-light); }
 
        .tab-bar { z-index: 1001; display: flex; justify-content: space-around; align-items: center; background-color: rgba(255, 255, 255, 0.85); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); padding: 8px 0; flex-shrink: 0; }
        body.dark-mode .tab-bar { background-color: rgba(28, 28, 30, 0.85); border-top-color: var(--border-color); }
        .tab-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-light); font-size: 11px; font-weight: 500; cursor: pointer; border: none; background: none; padding: 4px 12px; flex: 1; }
        .tab-item i { font-size: 22px; }
        .tab-item.active { color: var(--accent-color); }
         
        .card { background: var(--bg-secondary); border-radius: var(--radius); padding: 24px; border: 1px solid var(--border-color); }
        .campo, .modal-campo { margin-bottom: 18px; }
        label { display: block; font-size: 13px; color: var(--text-light); margin: 0 0 8px; font-weight: 500; }
        input, select { width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius); font-size: 15px; background: var(--bg-tertiary); transition: var(--transition-swift); font-family: inherit; color: var(--text-dark); }
        input:focus, select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2); outline: 0; }
        #forn, .fornEdit { text-transform: uppercase; }
        .anexo-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .file-input-label { display: flex; align-items: center; justify-content: center; padding: 14px; border: 1px dashed var(--border-color); border-radius: var(--radius); background: var(--bg-tertiary); cursor: pointer; color: var(--text-light); text-align: center; gap: 8px; }
        #fotos, #cameraInput, .edit-file-input { display: none; }
        #miniaturas-container, .miniaturas-container-edit { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
        .miniatura-wrapper { position: relative; }
        .miniatura-wrapper img { width: 64px; height: 64px; object-fit: cover; border-radius: 8px; border: 1px solid var(--border-color); cursor: pointer; }
        .miniatura-wrapper .not-found { width: 64px; height: 64px; border-radius: 8px; border: 1px dashed var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 28px; color: var(--text-light); background: var(--bg-primary); }
        .remove-foto { position: absolute; top: -8px; right: -8px; background: var(--button-danger); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: none; }
         
        .nota-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 16px; }
        .nota-item { background-color: var(--bg-secondary); border-radius: var(--radius); padding: 16px; border: 1px solid var(--border-color); }
        .nota-item.nota-enviada .nota-info { color: var(--button-success); }
        .nota-info { font-weight: 600; font-size: 16px; color: var(--text-dark); margin-bottom: 4px; transition: color 0.3s ease; }
        .nota-data, .nota-detalhes { font-size: 13px; color: var(--text-light); margin-bottom: 8px; }
        .actions-row { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-top: 16px; }
        .actions-row .actions-group { display: flex; gap: 8px; align-items: center; }
        .actions-row button { border: 0.5px solid var(--border-color); height: 38px; padding: 0 12px; border-radius: 8px; background: var(--bg-primary); color: var(--text-dark); font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .actions-row .icon-only { width: 38px; padding: 0; justify-content: center; font-size: 16px; }
        .actions-row .whatsapp-btn, .actions-row .sent-btn { background: var(--button-whatsapp); color: #fff; border: none; }
        .actions-row .sent-btn { background: var(--button-success); }
        .actions-row .edit-btn { color: var(--accent-color); } .actions-row .delete-btn { color: var(--button-danger); }
        .sem-fotos { font-size: 12px; color: var(--text-light); padding: 4px 8px; background: var(--bg-primary); border-radius: 6px; font-weight: 500; }
 
        .edit-panel, .checklist-container { display: none; padding: 16px; background-color: var(--bg-primary); border-radius: var(--radius); margin-top: 16px; animation: fadeIn 0.3s; border-top: 1px solid var(--border-color); }
        .edit-panel.show, .checklist-container.show { display: block; }
        .fotos-enviadas-status { text-align: center; color: var(--button-success); font-weight: 500; padding: 10px; background-color: var(--bg-secondary); border-radius: var(--radius); }
         
        .progress-bar-container { width: 100%; background-color: var(--bg-primary); border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--button-success); width: 0%; transition: width 0.5s ease; }
        .checklist-item { display: flex; align-items: center; margin-bottom: 12px; font-size: 14px; }
        .checklist-item input[type="checkbox"] { width: 18px; height: 18px; margin-right: 12px; cursor: pointer; accent-color: var(--accent-color); }
        .checklist-item label { margin: 0; font-weight: 400; color: var(--text-dark); cursor: pointer; }
 
        .settings-list-group {
            list-style: none; padding: 0; margin: 0 0 24px 0;
            background-color: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .settings-list-group li {
            border-bottom: 1px solid var(--border-color);
        }
        .settings-list-group li:last-child {
            border-bottom: none;
        }
        .settings-list-group a, #theme-toggle {
            display: flex; align-items: center; padding: 14px 16px;
            text-decoration: none; color: var(--text-dark);
            font-weight: 500; cursor: pointer; transition: background-color 0.2s;
        }
        .settings-list-group a:active { background-color: rgba(0,0,0,0.05); }
        body.dark-mode .settings-list-group a:active { background-color: rgba(255,255,255,0.05); }
        .settings-list-group .icon {
            width: 32px; height: 32px; border-radius: 8px;
            display: inline-flex; align-items: center; justify-content: center;
            color: white; font-size: 16px; margin-right: 16px; flex-shrink: 0;
        }
        .settings-list-group .fa-chevron-right { margin-left: auto; color: var(--text-light); opacity: 0.5; }
        #theme-toggle { width: 100%; }
        #theme-label { margin-right: auto; }
        .manage-list { margin-top: 24px; }
 
        #saida { width: 100%; height: 35vh; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; border: 2px dashed var(--border-color); border-radius: var(--radius); padding: 16px; background: var(--bg-secondary); color: var(--text-dark); font-size: 13px; line-height: 1.4; margin-bottom: 24px; }
        .actions-button { padding: 14px 20px; border: 0; border-radius: var(--radius); cursor: pointer; font-weight: 600; font-size: 16px; transition: var(--transition-swift); display: flex; align-items: center; justify-content: center; gap: 8px; font-family: inherit; color: #fff; width: 100%; }
        .actions { display: grid; gap: 12px; margin-top: 18px; }
         
        .toast { position: fixed; left: 50%; bottom: 80px; transform: translateX(-50%); background: rgba(44, 62, 80, 0.9); backdrop-filter: blur(5px); color: #fff; padding: 14px 22px; border-radius: 12px; display: none; font-size: 14px; z-index: 10000; animation: toastIn 0.3s ease; }
        .empty-state { text-align: center; color: var(--text-light); padding: 40px 0; }
         
        .modal-preview { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); justify-content: center; align-items: center; }
        .modal-preview-conteudo { max-width: 90%; max-height: 80%; object-fit: contain; }
        .modal-preview-fechar { position: fixed; top: 20px; right: 20px; color: white; font-size: 36px; background: rgba(0,0,0,0.5); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; border: none; }
        .modal-preview-nav { position: fixed; top: 50%; transform: translateY(-50%); width: 100%; display: flex; justify-content: space-between; padding: 0 10px; pointer-events: none; }
        .modal-preview-nav button { background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; font-size: 24px; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; transition: background 0.2s; pointer-events: all; }
        .modal-preview-bottom { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; align-items: center; }
        .modal-preview-action { background: var(--accent-color); color: white; border: none; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: var(--radius); display: flex; align-items: center; gap: 8px; }
        .modal-preview-action.delete { background: var(--button-danger); }
 
        @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fa-spin { animation: fa-spin 1s infinite linear; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes highlight-fade { from { background-color: rgba(0, 122, 255, 0.2); } to { background-color: transparent; } }
        .highlight-update { animation: highlight-fade 1.5s ease; }
    </style>
</head>
<body>

  <div id="login-screen">
      <div class="login-box">
          <div class="icon"><i id="login-icon" class="fas fa-lock"></i></div>
          <h1>Acesso Restrito</h1>
          <p>Por favor, insira a senha para continuar.</p>
          <input type="password" id="password-input" placeholder="••••••••">
          <div id="error-message" class="error-message"></div>
          <button id="login-button" class="actions-button" onclick="handleLogin()">Entrar</button>
      </div>
  </div>

  <div class="app-container" id="app-container">
    <div class="main-content">
        <div class="app-screen active" id="screen-add">
            <header class="header"><h1 class="header-title">Adicionar Nota</h1><button class="header-action" id="sync-btn-1" onclick="sincronizarManualmente(this)"><i class="fas fa-sync-alt"></i></button></header>
            <div class="screen-content"><div class="card">
                <div class="campo"><label for="data">Data</label><input type="text" id="data" placeholder="dd/mm/aaaa"></div>
                <div class="campo"><label for="nf">NF</label><input type="text" id="nf" placeholder="Número da Nota Fiscal"></div>
                <div class="campo"><label for="venc">Vencimento</label><input type="text" id="venc" placeholder="dd/mm/aaaa"></div>
                <div class="campo"><label for="valor">Valor Total</label><input id="valor" type="text" placeholder="Ex: 1200,50"></div>
                <div class="campo"><label for="forn">Nome do Fornecedor</label><input type="text" id="forn" placeholder="Nome do fornecedor" list="fornecedores-sugeridos"><datalist id="fornecedores-sugeridos"></datalist></div>
                <div class="campo"><label for="obs">Observações</label><select id="obs"><option value="">Recurso a ser pago</option></select></div>
                <div class="campo"><label>Anexar Imagens</label><div class="anexo-actions"><label for="fotos" class="file-input-label"><i class="fas fa-photo-video"></i> Selecionar</label><label for="cameraInput" class="file-input-label"><i class="fas fa-camera"></i> Câmera</label></div><input type="file" id="fotos" multiple="" accept="image/*"><input type="file" id="cameraInput" accept="image/*" capture="environment"><div id="miniaturas-container"></div></div>
                <div class="actions"><button id="salvarBtn" class="actions-button" style="background-color: var(--accent-color);" onclick="salvarNota()"><i class="fas fa-check"></i> Salvar</button></div>
            </div></div>
        </div>
        <div class="app-screen" id="screen-manage">
            <header class="header"><h1 class="header-title">Gerenciar</h1><button class="header-action" id="sync-btn-2" onclick="sincronizarManualmente(this)"><i class="fas fa-sync-alt"></i></button></header>
            <div class="screen-content"><ul id="lista-notas-pendentes" class="nota-list"></ul></div>
        </div>
        <div class="app-screen" id="screen-export">
            <header class="header"><h1 class="header-title">Exportar</h1><button class="header-action" id="sync-btn-3" onclick="sincronizarManualmente(this)"><i class="fas fa-sync-alt"></i></button></header>
            <div class="screen-content"><textarea id="saida" readonly="" placeholder="O texto das notas pendentes aparecerá aqui..."></textarea><div class="actions"><button class="actions-button" style="background-color: var(--accent-color);" onclick="exportar()"><i class="fas fa-clipboard"></i> Copiar</button><button class="actions-button" style="background-color: var(--button-whatsapp);" onclick="compartilharLista()"><i class="fas fa-share-alt"></i> Compartilhar</button><button class="actions-button" style="background-color: var(--text-light);" onclick="limpar()"><i class="fas fa-archive"></i> Arquivar Tudo</button></div></div>
        </div>
        <div class="app-screen" id="screen-history">
            <header class="header"><h1 class="header-title">Histórico</h1><button class="header-action" id="sync-btn-4" onclick="sincronizarManualmente(this)"><i class="fas fa-sync-alt"></i></button></header>
            <div class="screen-content"><ul id="lista-historico" class="nota-list"></ul><div id="historico-actions" class="actions" style="display: none; margin-top: 24px;"><button class="actions-button" style="background-color: var(--button-danger);" onclick="limparHistorico()"><i class="fas fa-trash"></i> Limpar Histórico</button></div></div>
        </div>
        <div class="app-screen" id="screen-settings">
            <header class="header"><h1 class="header-title">Ajustes</h1></header>
            <div class="screen-content">
                <ul class="settings-list-group">
                    <li><a onclick="openModal('fornecedores-modal')"><i class="icon fas fa-truck" style="background-color: #f5a623;"></i> Fornecedores <i class="fas fa-chevron-right"></i></a></li>
                    <li><a onclick="openModal('pedidos-modal')"><i class="icon fas fa-box" style="background-color: #bd10e0;"></i> Pedidos <i class="fas fa-chevron-right"></i></a></li>
                    <li><a onclick="openModal('observacoes-modal')"><i class="icon fas fa-comment-dots" style="background-color: #50e3c2;"></i> Observações <i class="fas fa-chevron-right"></i></a></li>
                </ul>
                <ul class="settings-list-group">
                    <li><div id="theme-toggle" onclick="toggleTheme()"><i class="icon fas fa-moon" style="background-color: #5856d6;"></i><span id="theme-label">Modo Escuro</span></div></li>
                </ul>
            </div>
        </div>
    </div>
 
    <div id="fornecedores-modal" class="modal-screen">
        <header class="header"><h1 class="header-title">Fornecedores</h1><button class="header-action close-modal" onclick="closeModal('fornecedores-modal')">×</button></header>
        <div class="screen-content"><div class="modal-campo"><label>Nome do Fornecedor</label><input type="text" id="forn-manage" placeholder="Digite para adicionar..."></div><button class="actions-button" style="background: var(--accent-color);" onclick="adicionarFornecedorManage()"><i class="fas fa-plus"></i> Adicionar Fornecedor</button><ul id="lista-fornecedores-manage" class="manage-list"></ul></div>
    </div>
    <div id="pedidos-modal" class="modal-screen">
        <header class="header"><h1 class="header-title">Pedidos & Recursos</h1><button class="header-action close-modal" onclick="closeModal('pedidos-modal')">×</button></header>
        <div class="screen-content"><div class="modal-campo"><label>Nº do Pedido</label><input type="text" id="pedido-num" placeholder="Digite o número do pedido"></div><div class="modal-campo"><label>Recurso</label><select id="pedido-recurso"><option value="">Selecione...</option><option value="Santa Casa">Santa Casa</option><option value="CTI">CTI</option></select></div><button class="actions-button" style="background: var(--accent-color); margin-top: 8px;" onclick="adicionarPedido()"><i class="fas fa-plus"></i> Adicionar</button><ul id="lista-pedidos" class="manage-list"></ul></div>
    </div>
    <div id="observacoes-modal" class="modal-screen">
        <header class="header"><h1 class="header-title">Observações</h1><button class="header-action close-modal" onclick="closeModal('observacoes-modal')">×</button></header>
        <div class="screen-content"><div class="modal-campo"><label>Nova Observação</label><input type="text" id="obs-manage" placeholder="Ex: C/C UPA"></div><button class="actions-button" style="background: var(--accent-color);" onclick="adicionarObservacaoManage()"><i class="fas fa-plus"></i> Adicionar Observação</button><ul id="lista-observacoes-manage" class="manage-list"></ul></div>
    </div>
 
    <nav class="tab-bar">
        <button class="tab-item active" data-screen="screen-add" data-index="0"><i class="fas fa-plus-circle"></i><span>Adicionar</span></button>
        <button class="tab-item" data-screen="screen-manage" data-index="1"><i class="fas fa-list-alt"></i><span>Gerenciar</span></button>
        <button class="tab-item" data-screen="screen-export" data-index="2"><i class="fas fa-file-export"></i><span>Exportar</span></button>
        <button class="tab-item" data-screen="screen-history" data-index="3"><i class="fas fa-history"></i><span>Histórico</span></button>
        <button class="tab-item" data-screen="screen-settings" data-index="4"><i class="fas fa-cog"></i><span>Ajustes</span></button>
    </nav>
  </div>
   
  <div id="modalPreview" class="modal-preview">
    <button class="modal-preview-fechar" onclick="fecharPreview()">×</button><img class="modal-preview-conteudo" id="imgPreview">
    <div class="modal-preview-nav"><button id="prevBtn" onclick="navegarFotos(-1)"><i class="fas fa-chevron-left"></i></button><button id="nextBtn" onclick="navegarFotos(1)"><i class="fas fa-chevron-right"></i></button></div>
    <div class="modal-preview-bottom"><button class="modal-preview-action" onclick="salvarFotoPreview()"><i class="fas fa-download"></i> Salvar</button><button class="modal-preview-action delete" onclick="excluirFotoPreview()"><i class="fas fa-trash-alt"></i> Excluir</button></div>
  </div>
  <div id="toast" class="toast" style="display: none;"></div>
 
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
    // --- LÓGICA DE LOGIN ---
    // DEFINA SUA SENHA AQUI
    const SENHA_CORRETA = "1206";

    function checkLogin() {
        if (localStorage.getItem('isLoggedIn') === 'true') {
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('login-screen').style.display = 'none';
        } else {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }
    }

    function handleLogin() {
        const passwordInput = document.getElementById('password-input');
        const errorMessage = document.getElementById('error-message');
        const loginIcon = document.getElementById('login-icon');
        
        if (passwordInput.value === SENHA_CORRETA) {
            localStorage.setItem('isLoggedIn', 'true');
            errorMessage.textContent = '';
            loginIcon.classList.replace('fa-lock', 'fa-unlock');
            loginIcon.parentElement.classList.add('unlocked');
            
            setTimeout(() => {
                checkLogin();
            }, 500); // Espera um pouco para a animação ser vista
        } else {
            errorMessage.textContent = 'Senha incorreta.';
            passwordInput.classList.add('shake');
            setTimeout(() => {
                passwordInput.classList.remove('shake');
                passwordInput.value = '';
            }, 820);
        }
    }
    document.getElementById('password-input').addEventListener('keyup', function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            document.getElementById("login-button").click();
        }
    });

    // --- FIM DA LÓGICA DE LOGIN ---


    const firebaseConfig = { apiKey: "AIzaSyAwcvJNJhLZ4Wqcw4Wz44XJ9kIdtqKJeJg", authDomain: "relacaonf.firebaseapp.com", projectId: "relacaonf", storageBucket: "relacaonf.appspot.com", messagingSenderId: "773864981925", appId: "1:773864981925:web:a4dadc51ec0a856832144c" };
    firebase.initializeApp(firebaseConfig);
    const firestore = firebase.firestore();
    const notasCollection = firestore.collection('notas');
    const historicoCollection = firestore.collection('historico');
    const settingsDocRef = firestore.collection('config').doc('appSettings');
    
    let notasPendentes = [], historicoNotas = [], fotosAcumuladas = [], fornecedoresSugeridos = [], observacoesSugeridas = [], pedidosRecursos = {};
    let openChecklistIds = new Set(), isChecklistUpdate = false;
    let fotoAtualIndex = 0, fotosAtuaisParaPreview = [], fotoAtualContexto = {};
 
    const DOM = {
        data: document.getElementById('data'), nf: document.getElementById('nf'), venc: document.getElementById('venc'), valor: document.getElementById('valor'), forn: document.getElementById('forn'), obs: document.getElementById('obs'), saida: document.getElementById('saida'), fotos: document.getElementById('fotos'), cameraInput: document.getElementById('cameraInput'), miniaturas: document.getElementById('miniaturas-container'), listaNotas: document.getElementById('lista-notas-pendentes'), listaHistorico: document.getElementById('lista-historico'), fornDatalist: document.getElementById('fornecedores-sugeridos'), listaPedidos: document.getElementById('lista-pedidos'), listaFornManage: document.getElementById('lista-fornecedores-manage'), fornManageInput: document.getElementById('forn-manage'), pedidoNumInput: document.getElementById('pedido-num'), pedidoRecursoSelect: document.getElementById('pedido-recurso'), listaObsManage: document.getElementById('lista-observacoes-manage'), obsManageInput: document.getElementById('obs-manage'), historicoActions: document.getElementById('historico-actions')
    };
     
    const checklistDefinition = { tirarFoto: "Tirar Foto", entradaSistema: "Entrada no sistema", produtosTransferidos: "Produtos transferidos", fotosNoServidor: "Fotos no servidor", cotacaoNoServidor: "Cotação no Servidor", notaEscaneada: "Nota Escaneada", estaNaPlanilha: "Está na planilha", cotacaoAnexada: "Cotação Anexada", notaCarimbada: "Nota Carimbada" };
    const DB_NAME = 'notasdb-fotos', DB_VERSION = 1; let db;
    function openDB() { return new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e => e.target.result.createObjectStore('fotos', { keyPath: 'id' }); r.onsuccess = e => { db = e.target.result; resolve(db); }; r.onerror = e => reject(e.target.errorCode); }); }
    function generateUniqueId() { return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; }
    function savePhotoDB(id, file) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); db.transaction(['fotos'], 'readwrite').objectStore('fotos').put({ id, file }).onsuccess = () => resolve(id); }); }
    function getPhotoDB(id) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); db.transaction(['fotos']).objectStore('fotos').get(id).onsuccess = e => resolve(e.target.result ? e.target.result.file : null); }); }
    function deletePhotoDB(id) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); db.transaction(['fotos'], 'readwrite').objectStore('fotos').delete(id).onsuccess = () => resolve(); }); }
     
    document.addEventListener('DOMContentLoaded', () => {
        checkLogin(); 

        const tabItems = document.querySelectorAll('.tab-item[data-screen]');
        tabItems.forEach(tab => {
            tab.addEventListener('click', () => {
                closeAllModals();
                const currentActive = document.querySelector('.app-screen.active');
                if (currentActive && currentActive.id === tab.dataset.screen) return;
                if (currentActive) currentActive.classList.remove('active');
                document.getElementById(tab.dataset.screen).classList.add('active');
                tabItems.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
            });
        });
        carregarEstado(); limparFormularioPrincipal(false);
        ["C/C CTI", "C/C SANTA CASA", "Recurso Proprio Santa Casa", "Recurso Proprio CTI", "PAGO", "REMESSA"].forEach(obs => adicionarObservacao(obs, true));
        DOM.data.addEventListener('input', () => formatarDataInput(DOM.data)); DOM.venc.addEventListener('input', () => formatarDataInput(DOM.venc)); DOM.valor.addEventListener('blur', formatarValorBlur);
        [DOM.forn, DOM.fornManageInput].forEach(el => el.addEventListener('input', () => el.value = el.value.toUpperCase()));
        const handleFiles = e => { fotosAcumuladas.push(...Array.from(e.target.files)); reconstruirMiniaturasAcumuladas(); e.target.value = null; };
        DOM.fotos.addEventListener('change', handleFiles); DOM.cameraInput.addEventListener('change', handleFiles);
    });
    function openModal(id) { document.getElementById(id)?.classList.add('active'); }
    function closeModal(id) { document.getElementById(id)?.classList.remove('active'); }
    function closeAllModals() { document.querySelectorAll('.modal-screen.active').forEach(modal => modal.classList.remove('active')); }
    function toast(msg){ const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=> t.style.display='none', 2500); }
    
    async function sincronizarManualmente(button) {
        const icon = button.querySelector('i');
        const allSyncButtons = document.querySelectorAll('.header-action[id^="sync-btn-"]');
        allSyncButtons.forEach(btn => {
            btn.disabled = true;
            btn.querySelector('i').classList.add('fa-spin');
        });
        toast("Sincronizando...");

        try {
            await Promise.all([
                (async () => {
                    const notasSnapshot = await notasCollection.orderBy('dataCriacao', 'desc').get();
                    notasPendentes = notasSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    rebuildNotasPendentesList();
                    DOM.saida.value = buildSaidaText();
                })(),
                (async () => {
                    const historicoSnapshot = await historicoCollection.orderBy('dataHistorico', 'desc').get();
                    historicoNotas = historicoSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    popularListaHistorico();
                })(),
                carregarConfiguracoesRemotas()
            ]);
            toast("✓ Sincronização concluída!");
        } catch (error) {
            console.error("Erro na sincronização manual:", error);
            toast("✕ Falha ao sincronizar.");
        } finally {
            setTimeout(() => {
                allSyncButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.querySelector('i').classList.remove('fa-spin');
                });
            }, 500);
        }
    }

    async function carregarConfiguracoesRemotas() {
        try {
            const doc = await settingsDocRef.get();
            if (doc.exists) {
                const data = doc.data();
                fornecedoresSugeridos = data.fornecedores || [];
                pedidosRecursos = data.pedidosRecursos || {};
            } else {
                fornecedoresSugeridos = [];
                pedidosRecursos = {};
            }
        } catch (error) {
            console.error("Erro ao carregar configurações:", error);
            fornecedoresSugeridos = [];
            pedidosRecursos = {};
        }
        popularDatalist();
        popularListaPedidos();
    }

    async function carregarEstado() {
        await carregarConfiguracoesRemotas();
        
        observacoesSugeridas = JSON.parse(localStorage.getItem('observacoes') || '[]'), popularObservacoesList(); 
        if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-toggle').querySelector('i').classList.replace('fa-moon', 'fa-sun'); document.getElementById('theme-label').textContent = 'Modo Claro'; }
        
        try { await openDB(); } catch(e) { console.error("Não foi possível iniciar o DB de fotos.", e); }
        
        notasCollection.orderBy('dataCriacao', 'desc').onSnapshot(snapshot => { if (snapshot.metadata.hasPendingWrites && isChecklistUpdate) { isChecklistUpdate = false; notasPendentes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); return; } handleSnapshotChanges(snapshot); }, error => toast("Erro ao carregar dados."));
        historicoCollection.orderBy('dataHistorico', 'desc').onSnapshot(snapshot => { historicoNotas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); popularListaHistorico(); }, error => console.error("Erro ao carregar histórico:", error));
    }

    function salvarObservacoesLocal() { 
        localStorage.setItem('observacoes', JSON.stringify(observacoesSugeridas)); 
    }
    
    function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); const themeToggle = document.getElementById('theme-toggle'); themeToggle.querySelector('i').classList.toggle('fa-moon', !isDark); themeToggle.querySelector('i').classList.toggle('fa-sun', isDark); document.getElementById('theme-label').textContent = isDark ? 'Modo Claro' : 'Modo Escuro'; }
    
    async function salvarNota() {
        const fornecedor = DOM.forn.value.trim().toUpperCase(); if (!fornecedor) return toast("O campo 'Fornecedor' é obrigatório.");
        const salvarBtn = document.getElementById('salvarBtn'); salvarBtn.disabled = true; salvarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        try {
            const photoIds = await Promise.all(fotosAcumuladas.map(file => savePhotoDB(generateUniqueId(), file)));
            const checklistInicial = Object.keys(checklistDefinition).reduce((acc, key) => ({ ...acc, [key]: false }), {}); checklistInicial.tirarFoto = photoIds.length > 0;
            await notasCollection.add({ data: DOM.data.value.trim(), nf: DOM.nf.value.trim(), vencimento: DOM.venc.value.trim(), valor: DOM.valor.value.trim(), fornecedor, obs: DOM.obs.value.trim(), fotos: photoIds, enviada: false, dataCriacao: new Date().toISOString(), checklist: checklistInicial });
            await adicionarFornecedor(fornecedor, true);
            limparFormularioPrincipal(true); toast("✓ Nota salva com sucesso!");
        } catch (e) { console.error("Erro ao salvar nota:", e); toast("✕ Erro ao salvar a nota."); } 
        finally { salvarBtn.disabled = false; salvarBtn.innerHTML = '<i class="fas fa-check"></i> Salvar'; }
    }

    async function deletarNota(id) { if (!confirm("Tem certeza que deseja excluir esta nota?")) return; const nota = notasPendentes.find(n => n.id === id); if (nota?.fotos?.length > 0) await Promise.all(nota.fotos.map(id => deletePhotoDB(id))); await notasCollection.doc(id).delete(); toast("🗑️ Nota excluída!"); }
    async function limpar() { if (notasPendentes.length === 0) return toast("Nenhuma nota para arquivar."); if (!confirm(`Arquivar ${notasPendentes.length} nota(s) no histórico? As fotos serão excluídas.`)) return; const batch = firestore.batch(); for (const nota of notasPendentes) { const { id, ...notaData } = nota; notaData.dataHistorico = new Date().toLocaleString('pt-BR'); batch.set(historicoCollection.doc(), notaData); batch.delete(notasCollection.doc(id)); if (nota.fotos?.length > 0) await Promise.all(nota.fotos.map(photoId => deletePhotoDB(photoId))); } await batch.commit(); toast("Notas arquivadas no histórico."); }
    async function limparHistorico() { if (historicoNotas.length === 0 || !confirm("Tem certeza que deseja apagar TODO o histórico? Esta ação é irreversível.")) return; const batch = firestore.batch(); historicoNotas.forEach(nota => batch.delete(historicoCollection.doc(nota.id))); await batch.commit(); toast("Histórico limpo com sucesso!"); }
    function toggleEditPanel(btn, notaId) { const notaItem = btn.closest('.nota-item'); const editPanel = notaItem.querySelector('.edit-panel'); if (openChecklistIds.has(notaId)) { toggleChecklist(btn, notaId); } const isVisible = editPanel.classList.contains('show'); document.querySelectorAll('.edit-panel.show').forEach(p => p.classList.remove('show')); if (!isVisible) { editPanel.classList.add('show'); reconstruirPainelFotosEdit(notaId); } }
    async function salvarEdicao(id) { const notaItem = document.querySelector(`li[data-note-id="${id}"]`); const data = { fornecedor: notaItem.querySelector(`.fornEdit`).value.trim().toUpperCase(), nf: notaItem.querySelector(`.nfEdit`).value.trim(), vencimento: notaItem.querySelector(`.vencEdit`).value.trim(), valor: notaItem.querySelector(`.valorEdit`).value.trim(), obs: notaItem.querySelector(`.obsEdit`).value.trim() }; await notasCollection.doc(id).update(data); await adicionarFornecedor(data.fornecedor, true); toast('✓ Nota editada e salva!'); notaItem.querySelector('.edit-panel').classList.remove('show'); }
    async function gerarImagemSeparadora(fornecedor, nf) { const c = document.createElement('canvas'); c.width=600; c.height=150; const ctx=c.getContext('2d'); ctx.fillStyle='#34495e'; ctx.fillRect(0,0,600,150); ctx.fillStyle='#ecf0f1'; ctx.font='bold 30px -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif'; ctx.textAlign='center'; ctx.fillText(`${fornecedor} ${nf}`,300,70); ctx.font='50px sans-serif'; ctx.fillText(`↓`,300,130); return new Promise(r=>c.toBlob(r,'image/png')); }
    async function compartilharNota(id) { const nota = notasPendentes.find(n => n.id === id); if (nota.enviada) return toast("Esta nota já foi enviada."); try { toast("Preparando fotos..."); const files = await Promise.all((nota.fotos || []).map(id => getPhotoDB(id))); const validFiles = files.filter(f => f), separador = await gerarImagemSeparadora(nota.fornecedor, nota.nf); const filesToShare = [new File([separador], 'separador.png', { type: 'image/png' }), ...validFiles]; if (navigator.share) await navigator.share({ files: filesToShare, text: `${nota.fornecedor} ${nota.nf || ''}` }); else return toast("Compartilhamento não suportado."); await Promise.all((nota.fotos || []).map(id => deletePhotoDB(id))); await notasCollection.doc(id).update({ enviada: true, fotos: [] }); toast("✓ Nota compartilhada e fotos locais removidas!"); } catch (error) { if (error.name !== 'AbortError') toast("Erro ao compartilhar."); } }
    function toggleChecklist(btn, notaId) { const notaItem = btn.closest('.nota-item'); const checklistContainer = notaItem.querySelector('.checklist-container'); if (notaItem.querySelector('.edit-panel.show')) { toggleEditPanel(btn, notaId); } if (openChecklistIds.has(notaId)) { openChecklistIds.delete(notaId); checklistContainer.classList.remove('show'); } else { openChecklistIds.add(notaId); checklistContainer.classList.add('show'); } }
    function gerarHtmlChecklist(nota) { let html = ''; const checklistData = nota.checklist || {}; for (const key in checklistDefinition) { const isChecked = checklistData[key] ? 'checked' : ''; html += `<div class="checklist-item"><input type="checkbox" id="check-${key}-${nota.id}" ${isChecked} onchange="atualizarChecklist('${nota.id}', '${key}', this.checked)"><label for="check-${key}-${nota.id}">${checklistDefinition[key]}</label></div>`; } return html; }
    function atualizarChecklist(notaId, tarefa, isChecked) { isChecklistUpdate = true; const updateData = {}; updateData[`checklist.${tarefa}`] = isChecked; notasCollection.doc(notaId).update(updateData).catch(error => toast("Erro ao salvar progresso.")); const nota = notasPendentes.find(n => n.id === notaId); if (!nota) return; if (!nota.checklist) nota.checklist = {}; nota.checklist[tarefa] = isChecked; const totalTasks = Object.keys(checklistDefinition).length; const completedTasks = Object.values(nota.checklist).filter(Boolean).length; const progressPercent = (completedTasks / totalTasks) * 100; const notaItemEl = document.querySelector(`li[data-note-id="${notaId}"]`); if (notaItemEl) { const progressBar = notaItemEl.querySelector('.progress-bar'); const progressButton = notaItemEl.querySelector('.progress-btn'); if (progressBar) progressBar.style.width = `${progressPercent}%`; if (progressButton) progressButton.textContent = `Progresso: ${completedTasks}/${totalTasks}`; } }
    function handleSnapshotChanges(snapshot) {
        const newNotas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); notasPendentes = newNotas;
        rebuildNotasPendentesList(); DOM.saida.value = buildSaidaText();
    }
    function rebuildNotasPendentesList() {
        if (!DOM.listaNotas) return;
        const createNotaHTML = (nota) => {
            let shareBtnHTML;
            if(nota.enviada) { shareBtnHTML = `<button class="sent-btn icon-only" title="Enviada"><i class="fas fa-check"></i></button>`; }
            else if(nota.fotos?.length > 0) { shareBtnHTML = `<button class="whatsapp-btn icon-only" onclick="compartilharNota('${nota.id}')"><i class="fab fa-whatsapp"></i></button>`; }
            else { shareBtnHTML = `<span class="sem-fotos">SEM FOTOS</span>`; }
            const totalTasks = Object.keys(checklistDefinition).length; const completedTasks = nota.checklist ? Object.values(nota.checklist).filter(Boolean).length : 0; const progressPercent = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            return `<div class="nota-info">${nota.fornecedor} ${nota.nf || ''}</div><div class="nota-data">Criada em: ${new Date(nota.dataCriacao).toLocaleString('pt-BR')}</div><div class="nota-detalhes">Venc: ${nota.vencimento||'N/A'} | Valor: ${nota.valor||'N/A'}</div><div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div><div class="actions-row"><div class="actions-group"><button class="progress-btn" onclick="toggleChecklist(this, '${nota.id}')">Progresso: ${completedTasks}/${totalTasks}</button></div><div class="actions-group">${shareBtnHTML}<button class="edit-btn icon-only" onclick="toggleEditPanel(this, '${nota.id}')"><i class="fas fa-pen"></i></button><button class="delete-btn icon-only" onclick="deletarNota('${nota.id}')"><i class="fas fa-trash"></i></button></div></div><div class="edit-panel"></div><div class="checklist-container">${gerarHtmlChecklist(nota)}</div>`;
        };
        if (notasPendentes.length === 0) { DOM.listaNotas.innerHTML = `<li class="empty-state">Nenhuma nota pendente.</li>`; return; }
        const domNoteIds = new Set(Array.from(DOM.listaNotas.children).map(li => li.dataset.noteId));
        const newNoteIds = new Set(notasPendentes.map(n => n.id));
        for (const id of domNoteIds) { if (!newNoteIds.has(id)) { const el = DOM.listaNotas.querySelector(`li[data-note-id="${id}"]`); if(el) el.remove(); } }
        notasPendentes.forEach((nota, index) => {
            const existingEl = DOM.listaNotas.querySelector(`li[data-note-id="${nota.id}"]`);
            const newHTML = createNotaHTML(nota);
            if (existingEl) { if(existingEl.innerHTML !== newHTML) { existingEl.innerHTML = newHTML; existingEl.className = `nota-item ${nota.enviada ? 'nota-enviada' : ''}`; existingEl.classList.add('highlight-update'); } }
            else {
                const li = document.createElement('li');
                li.className = `nota-item ${nota.enviada ? 'nota-enviada' : ''}`;
                li.dataset.noteId = nota.id;
                li.innerHTML = newHTML;
                const referenceNode = DOM.listaNotas.children[index];
                DOM.listaNotas.insertBefore(li, referenceNode || null);
                li.classList.add('highlight-update');
            }
        });
    }
    function popularListaHistorico() { DOM.listaHistorico.innerHTML = ''; if (historicoNotas.length === 0) { DOM.listaHistorico.innerHTML = `<li class="empty-state">O histórico está vazio.</li>`; DOM.historicoActions.style.display = 'none'; } else { DOM.historicoActions.style.display = 'grid'; historicoNotas.forEach(nota => { const li = document.createElement('li'); li.classList.add('nota-item'); li.innerHTML = `<div class="nota-info">${nota.fornecedor} ${nota.nf || ''}</div><div class="nota-detalhes">Venc: ${nota.vencimento||'N/A'} | Valor: ${nota.valor||'N/A'} | Obs: ${nota.obs||'N/A'}</div><div class="nota-data">Arquivado em: ${nota.dataHistorico}</div>`; DOM.listaHistorico.appendChild(li); }); } }
    function reconstruirMiniaturasAcumuladas() { DOM.miniaturas.innerHTML = ''; fotosAcumuladas.forEach((file, i) => { const w = document.createElement('div'), img = document.createElement('img'), btn = document.createElement('button'); w.className = 'miniatura-wrapper'; img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src); img.onclick = () => abrirPreview(fotosAcumuladas, i, { type: 'nova' }); btn.className = 'remove-foto'; btn.innerHTML = '×'; btn.onclick = (e) => { e.stopPropagation(); fotosAcumuladas.splice(i, 1); reconstruirMiniaturasAcumuladas(); }; w.append(img, btn); DOM.miniaturas.appendChild(w); }); }
    async function reconstruirPainelFotosEdit(notaId) {
        const nota = notasPendentes.find(n => n.id === notaId); if (!nota) return;
        const painelEdicao = document.querySelector(`li[data-note-id="${notaId}"] .edit-panel`);
        painelEdicao.innerHTML = `<div class="campo"><label>Fornecedor</label><input type="text" class="fornEdit" value="${nota.fornecedor||''}"></div><div class="campo"><label>NF</label><input type="text" class="nfEdit" value="${nota.nf||''}"></div><div class="campo"><label>Vencimento</label><input type="text" class="vencEdit" value="${nota.vencimento||''}" oninput="formatarDataInput(this)"></div><div class="campo"><label>Valor</label><input type="text" class="valorEdit" value="${nota.valor||''}" onblur="formatarValorBlur(event)"></div><div class="campo"><label>Observações</label><select class="obsEdit">${DOM.obs.innerHTML}</select></div><div class="campo fotos-edit-container"></div><div class="actions"><button class="actions-button" style="background:var(--button-success);" onclick="salvarEdicao('${nota.id}')"><i class="fas fa-save"></i> Salvar</button></div>`;
        painelEdicao.querySelector('.obsEdit').value = nota.obs || '';
        const container = painelEdicao.querySelector('.fotos-edit-container');
        if (nota.enviada) {
            container.innerHTML = `<label>Anexos</label><div class="fotos-enviadas-status"><i class="fas fa-check-circle"></i> Fotos já enviadas!</div>`;
        } else {
            container.innerHTML = `<label>Anexar/Remover Fotos</label><div class="anexo-actions"><label for="edit-fotos-${notaId}" class="file-input-label"><i class="fas fa-photo-video"></i> Selecionar</label><label for="edit-camera-${notaId}" class="file-input-label"><i class="fas fa-camera"></i> Câmera</label></div><input type="file" id="edit-fotos-${notaId}" class="edit-file-input" multiple accept="image/*" /><input type="file" id="edit-camera-${notaId}" class="edit-file-input" accept="image/*" capture="environment" /><div class="miniaturas-container-edit"></div>`;
            const handleEditFiles = async e => { const newIds = await Promise.all(Array.from(e.target.files).map(f => savePhotoDB(generateUniqueId(), f))); await notasCollection.doc(nota.id).update({ fotos: [...(nota.fotos || []), ...newIds] }); toast(`${e.target.files.length} foto(s) adicionada(s).`); };
            container.querySelector(`#edit-fotos-${notaId}`).addEventListener('change', handleEditFiles); container.querySelector(`#edit-camera-${notaId}`).addEventListener('change', handleEditFiles);
            reconstruirMiniaturasEdit(notaId);
        }
    }
    async function reconstruirMiniaturasEdit(notaId) { const nota = notasPendentes.find(n => n.id === notaId); if (!nota || !nota.fotos) return; const container = document.querySelector(`li[data-note-id="${notaId}"] .miniaturas-container-edit`); if(!container) return; container.innerHTML = ''; const files = await Promise.all(nota.fotos.map(id => getPhotoDB(id).catch(() => null))); nota.fotos.forEach((photoId, i) => { const file = files[i], wrapper = document.createElement('div'); wrapper.className = 'miniatura-wrapper'; if (file) { const img = document.createElement('img'), btn = document.createElement('button'); img.src = URL.createObjectURL(file); const fileIndexInThumbnails = files.filter(f => f).indexOf(file); img.onclick = () => abrirPreview(files.filter(f => f), fileIndexInThumbnails, { type: 'nota', id: notaId, photoId: photoId }); btn.className = 'remove-foto'; btn.innerHTML = '×'; btn.onclick = e => { e.stopPropagation(); removerFotoEdit(notaId, i); }; wrapper.append(img, btn); } else { wrapper.innerHTML = `<div class="not-found"><i class="fas fa-ghost"></i></div>`; } container.appendChild(wrapper); }); }
    async function removerFotoEdit(notaId, fIndex) { if (!confirm("Remover esta imagem da nota?")) return; const nota = notasPendentes.find(n => n.id === notaId); const photoId = nota.fotos[fIndex], updatedIds = nota.fotos.filter((_, i) => i !== fIndex); await notasCollection.doc(nota.id).update({ fotos: updatedIds }); await deletePhotoDB(photoId); toast("Imagem removida."); }
    
    async function adicionarFornecedor(forn, noToast = false) {
        const f = forn.trim().toUpperCase();
        if (f && !fornecedoresSugeridos.includes(f)) {
            fornecedoresSugeridos.push(f);
            await settingsDocRef.set({ fornecedores: firebase.firestore.FieldValue.arrayUnion(f) }, { merge: true });
            popularDatalist();
            if (!noToast) toast(`Fornecedor ${f} adicionado!`);
        }
    }
    async function adicionarFornecedorManage() { const f = DOM.fornManageInput.value.trim(); if (f) { await adicionarFornecedor(f); DOM.fornManageInput.value = ''; } }
    async function deletarFornecedor(f) {
        if (confirm(`Excluir o fornecedor ${f}?`)) {
            fornecedoresSugeridos = fornecedoresSugeridos.filter(i => i !== f);
            await settingsDocRef.update({ fornecedores: firebase.firestore.FieldValue.arrayRemove(f) });
            popularDatalist();
            toast(`Fornecedor ${f} excluído.`);
        }
    }
    function popularDatalist() { DOM.fornDatalist.innerHTML = ''; fornecedoresSugeridos.sort().forEach(f => DOM.fornDatalist.innerHTML += `<option value="${f}"></option>`); popularListaFornecedores(); }
    function popularListaFornecedores() { DOM.listaFornManage.innerHTML = ''; fornecedoresSugeridos.sort().forEach(f => DOM.listaFornManage.innerHTML += `<li>${f} <button onclick="deletarFornecedor('${f}')"><i class="fas fa-times-circle"></i></button></li>`); }
    
    function adicionarObservacao(obs, noToast = false) { const o = obs.trim(); if (o && !observacoesSugeridas.includes(o)) { observacoesSugeridas.push(o); salvarObservacoesLocal(); popularObservacoesList(); if (!noToast) toast(`Observação "${o}" adicionada!`); } }
    function adicionarObservacaoManage() { const o = DOM.obsManageInput.value.trim(); if (o) { adicionarObservacao(o); DOM.obsManageInput.value = ''; } }
    function deletarObservacao(o) { if (confirm(`Excluir a observação "${o}"?`)) { observacoesSugeridas = observacoesSugeridas.filter(i => i !== o); salvarObservacoesLocal(); popularObservacoesList(); toast(`Observação "${o}" excluída.`); } }
    function popularObservacoesList() { DOM.obs.innerHTML = '<option value="">Recurso a ser pago</option>'; observacoesSugeridas.sort().forEach(o => DOM.obs.innerHTML += `<option value="${o}">${o}</option>`); DOM.listaObsManage.innerHTML = ''; observacoesSugeridas.sort().forEach(o => DOM.listaObsManage.innerHTML += `<li>${o} <button onclick="deletarObservacao('${o}')"><i class="fas fa-times-circle"></i></button></li>`); }
    
    async function adicionarPedido() {
        const pNum = DOM.pedidoNumInput.value.trim(), r = DOM.pedidoRecursoSelect.value;
        if (pNum && r) {
            pedidosRecursos[pNum] = r;
            const updateData = {};
            updateData[`pedidosRecursos.${pNum}`] = r;
            await settingsDocRef.set(updateData, { merge: true });
            popularListaPedidos();
            DOM.pedidoNumInput.value = ''; DOM.pedidoRecursoSelect.value = '';
            toast(`Pedido ${pNum} adicionado!`);
        } else {
            toast('Preencha o pedido e o recurso.');
        }
    }
    async function deletarPedido(p) {
        if (confirm(`Excluir o pedido ${p}?`)) {
            delete pedidosRecursos[p];
            const updateData = {};
            updateData[`pedidosRecursos.${p}`] = firebase.firestore.FieldValue.delete();
            await settingsDocRef.update(updateData);
            popularListaPedidos();
            toast(`Pedido ${p} excluído.`);
        }
    }
    function popularListaPedidos() { DOM.listaPedidos.innerHTML = ''; Object.keys(pedidosRecursos).sort((a,b) => a-b).forEach(p => DOM.listaPedidos.innerHTML += `<li>${p} - ${pedidosRecursos[p]} <button onclick="deletarPedido('${p}')"><i class="fas fa-times-circle"></i></button></li>`); }
    
    function formatarDataInput(input) { let v = input.value.replace(/\D/g, '').substring(0, 8); if (v.length > 4) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4)}`; else if (v.length > 2) v = `${v.slice(0,2)}/${v.slice(2)}`; input.value = v; }
    function formatarValorBlur(event) { let v = event.target.value.replace(/\./g, '').replace(',', '.').replace(/[^\d.]/g, ''); if (v) event.target.value = parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    function getLinha(nota) { let v = nota.vencimento, o = nota.obs; if (nota.obs === "REMESSA") { v = "REMESSA"; o = "Recurso Proprio Santa Casa"; } return [nota.data, nota.nf, v, nota.valor, "", nota.fornecedor, "", "", o].join("\t"); }
    function buildSaidaText() { return notasPendentes.map(getLinha).join("\n"); }
    async function exportar() { if (DOM.saida.value === "") return toast("Nada para copiar."); await navigator.clipboard.writeText(DOM.saida.value); toast("✓ Lista copiada!"); }
    async function compartilharLista() { const texto = DOM.saida.value; if (!texto.trim()) return toast("Nada para compartilhar."); if (navigator.share) { await navigator.share({ title: 'Relação de Notas Fiscais', text: texto }); } else { await navigator.clipboard.writeText(texto); toast("Compartilhamento não suportado. Lista copiada!"); } }
    function limparFormularioPrincipal(comFoco = true) {
        document.querySelector('#screen-add .screen-content').scrollTo({ top: 0, behavior: 'smooth' });
        const today = new Date();
        DOM.data.value = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
        [DOM.nf, DOM.venc, DOM.valor, DOM.forn, DOM.obs].forEach(el => el.value = ""); fotosAcumuladas = []; reconstruirMiniaturasAcumuladas();
        if(comFoco) setTimeout(() => DOM.nf.focus(), 350);
    }
    async function abrirPreview(fotos, index, contexto) { const modal = document.getElementById('modalPreview'), imgPreview = document.getElementById('imgPreview'); fotosAtuaisParaPreview = fotos; fotoAtualIndex = index; fotoAtualContexto = contexto; const file = fotos[index]; if(file) imgPreview.src = URL.createObjectURL(file); modal.style.display = 'flex'; document.getElementById('prevBtn').style.display = index > 0 ? 'block' : 'none'; document.getElementById('nextBtn').style.display = index < fotos.length - 1 ? 'block' : 'none'; }
    function fecharPreview() { document.getElementById('modalPreview').style.display = 'none'; URL.revokeObjectURL(document.getElementById('imgPreview').src); }
    function navegarFotos(dir) { const novoIndex = fotoAtualIndex + dir; if (novoIndex >= 0 && novoIndex < fotosAtuaisParaPreview.length) { abrirPreview(fotosAtuaisParaPreview, novoIndex, fotoAtualContexto); } }
    function salvarFotoPreview() { const a = document.createElement('a'); a.href = document.getElementById('imgPreview').src; a.download = `nota_fiscal_${Date.now()}.png`; a.click(); toast("Imagem salva!"); }
    async function excluirFotoPreview() {
        if (!confirm("Excluir esta imagem?")) return;
        if (fotoAtualContexto.type === 'nova') { fotosAcumuladas.splice(fotoAtualIndex, 1); reconstruirMiniaturasAcumuladas(); }
        else if (fotoAtualContexto.type === 'nota') { const nota = notasPendentes.find(n => n.id === fotoAtualContexto.id); const photoIndexInNota = nota.fotos.indexOf(fotoAtualContexto.photoId); if(photoIndexInNota > -1) await removerFotoEdit(fotoAtualContexto.id, photoIndexInNota); }
        toast("Imagem excluída.");
        if (fotosAtuaisParaPreview.length <= 1) { fecharPreview(); } else { const newIndex = Math.max(0, fotoAtualIndex - 1); fotosAtuaisParaPreview.splice(fotoAtualIndex, 1); abrirPreview(fotosAtuaisParaPreview, newIndex, fotoAtualContexto); }
    }
</script>
 
 
</body></html>
