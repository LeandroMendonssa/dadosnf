<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Relação de Notas Fiscais</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Minhas Notas">
  <link rel="apple-touch-icon" href="favicon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --bg-primary: #f0f2f5;
      --bg-card: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #5e7280;
      --border-color: #e0e2e5;
      --button-primary: #3498db;
      --button-secondary: #95a5a6;
      --button-success: #2ecc71;
      --button-danger: #e74c3c;
      --shadow: rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    body.dark-mode {
      --bg-primary: #121212;
      --bg-card: #1e1e1e;
      --text-dark: #e0e0e0;
      --text-light: #a0a0a0;
      --border-color: #333;
      --shadow: rgba(255, 255, 255, 0.08);
    }
    
    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html, body {
      overscroll-behavior: auto;
      -webkit-tap-highlight-color: transparent;
      height: 100%;
    }

    body {
      margin: 0;
      padding: 24px;
      background: var(--bg-primary);
      color: var(--text-dark);
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 15px;
      line-height: 1.47059;
      font-weight: 400;
      letter-spacing: -0.022em;
      transition: background var(--transition);
      touch-action: pan-x pan-y;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-text-size-adjust: none;
    }

    body.popup-open {
        overflow: hidden;
    }

    .wrap {
      max-width: 680px;
      margin: 0 auto;
      padding-top: 60px;
    }

    h1 {
      margin: 0 0 28px;
      text-align: center;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.003em;
      color: var(--text-dark);
      animation: fadeInDown 0.6s ease;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px var(--shadow);
      padding: 28px;
      animation: fadeInUp 0.6s ease;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 8px 18px var(--shadow);
    }

    .campo {
      margin-bottom: 22px;
      position: relative;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--text-light);
      margin: 0 0 8px;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 15px;
      background: var(--bg-card);
      transition: var(--transition);
      font-family: inherit;
      color: var(--text-dark);
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--button-primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: 0;
    }

    #forn, #fornEdit {
      text-transform: uppercase;
    }
    
    .file-input-label {
      display: block;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: var(--bg-card);
      cursor: pointer;
      transition: var(--transition);
      font-size: 15px;
      color: var(--text-light);
      text-align: center;
    }

    .file-input-label:hover {
      border-color: var(--button-primary);
      background: rgba(52, 152, 219, 0.04);
    }

    .file-input-label.active {
      border-color: var(--button-primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .file-input-label i {
      margin-right: 8px;
      color: var(--button-primary);
    }

    #fotos, .edit-file-input {
      display: none;
    }

    #miniaturas-container, .miniaturas-container-edit {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .miniatura-wrapper {
      position: relative;
      display: inline-block;
    }

    #miniaturas-container img, .miniaturas-container-edit img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: var(--transition);
      cursor: pointer;
    }

    #miniaturas-container img:hover, .miniaturas-container-edit img:hover {
      transform: scale(1.05);
    }

    .remove-foto {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--button-danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      border: none;
    }

    .status-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .status-container .hint {
      margin-top: 0;
    }
    
    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    
    .actions button {
      padding: 14px 20px;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
      letter-spacing: -0.01em;
      color: #fff;
    }
    
    .actions button.full-width {
        grid-column: 1 / -1;
    }

    #salvarBtn {
      background: var(--button-success);
    }

    #salvarBtn:hover {
      opacity: 0.9;
    }

    #gerenciarBtn {
      background: var(--button-primary);
    }

    #gerenciarBtn:hover {
      opacity: 0.9;
    }

    #exportBtn {
      background: var(--button-secondary);
      color: #fff;
    }

    #exportBtn:hover {
      opacity: 0.9;
    }
    
    #limparBtn {
      background: #6c757d;
      color: #fff;
    }

    #limparBtn:hover {
      background: #5a6268;
    }

    .hint {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 6px;
    }

    #saida {
      width: 100%;
      height: 200px;
      margin-top: 22px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius);
      padding: 16px;
      background: var(--bg-primary);
      color: var(--text-dark);
      font-size: 13px;
      line-height: 1.4;
    }

    select {
      padding: 14px 16px;
    }
    
    .popup-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s;
        overflow-y: auto;
    }
    
    .popup-content {
        background-color: var(--bg-card);
        padding: 24px;
        position: relative;
        animation: slideInTop 0.3s;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border-radius: 0;
        overflow-y: auto;
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
    }
    
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .popup-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .close-popup {
        color: var(--text-light);
        font-size: 28px;
        font-weight: bold;
        transition: color 0.2s;
        cursor: pointer;
    }
    
    .close-popup:hover, .close-popup:focus {
        color: var(--text-dark);
        text-decoration: none;
    }
    
    #lista-notas-pendentes, #lista-historico, #lista-pedidos, #lista-fornecedores-manage {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nota-item {
      padding: 16px;
      margin-bottom: 10px;
      transition: var(--transition);
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px var(--shadow);
      border-radius: var(--radius);
    }

    .nota-item:hover {
      box-shadow: 0 4px 12px var(--shadow);
    }

    .nota-info {
      font-weight: 500;
      font-size: 14px;
      color: var(--text-dark);
      margin-bottom: 8px;
    }

    .nota-detalhes {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 8px;
    }

    .nota-enviada .nota-info {
      color: var(--button-success);
    }

    .nota-enviada .nota-info i {
      margin-left: 8px;
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .actions-item {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions-item button {
      height: 38px;
      width: 38px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-dark);
      border: 1px solid var(--border-color);
      transition: var(--transition);
    }

    .actions-item button:hover {
      transform: scale(1.05);
    }
    
    .actions-item .whatsapp-btn {
      background: #25D366;
      color: #fff;
      border: none;
    }

    .actions-item .whatsapp-btn:hover {
      background: #128C7E;
    }

    .actions-item i {
      font-size: 16px;
    }

    .sem-fotos {
      font-size: 12px;
      color: var(--text-light);
      padding: 4px 8px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-left: 8px;
    }

    .edit-panel {
      display: none;
      padding: 15px;
      background-color: var(--bg-primary);
      border-radius: var(--radius);
      margin-top: 10px;
      transition: all 0.3s ease-in-out;
      overflow: visible;
    }

    .edit-panel.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    .edit-panel .campo {
      margin-bottom: 10px;
    }

    .edit-fields-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .edit-fields-row .campo {
      flex: 1 1 30%;
      min-width: 150px;
    }

    .edit-fields-row input, .edit-fields-row select {
      padding: 10px;
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .edit-panel .actions {
        display: flex;
        justify-content: flex-end;
    }
    
    .edit-panel .actions button {
        flex: unset;
        width: auto;
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: rgba(44, 62, 80, 0.9);
      color: #fff;
      padding: 14px 22px;
      border-radius: 12px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
      display: none;
      font-size: 14px;
      z-index: 9999;
      animation: toastIn 0.3s ease;
      font-family: inherit;
      font-weight: 400;
      letter-spacing: -0.01em;
    }

    footer {
      margin-top: 28px;
      text-align: center;
      color: var(--text-light);
      font-size: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      letter-spacing: 0.4px;
      font-family: inherit;
    }

    footer b {
      font-weight: 600;
    }
    
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 54px;
      background-color: var(--bg-card);
      z-index: 1001;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 8px var(--shadow);
      transition: background var(--transition);
    }
    
    .top-header .left-icons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .top-header .right-icons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .top-header button {
      background: none;
      border: none;
      font-size: 18px;
      color: var(--text-dark);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .top-header button:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .top-header .logo {
        height: 24px;
        width: auto;
    }

    .top-header #theme-toggle i {
      transition: color 0.3s ease;
    }
    
    .pedido-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .pedido-container input, .pedido-container select {
      flex: 1;
    }
    
    #lista-pedidos {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    #lista-pedidos li {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-dark);
    }
    
    #lista-pedidos button {
      background: none;
      border: none;
      color: var(--button-danger);
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }
    
    .paginacao {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      padding: 10px 0;
    }
    
    .paginacao button {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-dark);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .paginacao button:hover {
      background: var(--bg-primary);
    }
    
    .paginacao button.ativo {
      background: var(--button-primary);
      color: white;
      border-color: var(--button-primary);
    }
    
    .modal-preview {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
    }
    
    .modal-preview-conteudo {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    .modal-preview-fechar {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 36px;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .modal-preview-fechar:hover {
      background: rgba(0,0,0,0.7);
    }

    .modal-preview-nav {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 10px;
    }

    .modal-preview-nav button {
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 10px;
        font-size: 24px;
        cursor: pointer;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        transition: background 0.2s;
    }

    .modal-preview-nav button:hover {
        background: rgba(0,0,0,0.7);
    }

    .modal-preview-bottom {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .modal-preview-delete {
      background: var(--button-danger);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-preview-save {
      background: var(--button-success);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-list {
        margin-top: 15px;
        text-align: center;
        padding-bottom: 10px;
    }

    .btn-list button.destructive {
        background: var(--button-danger);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }
    
    .separator-line {
        height: 0.5px;
        background-color: var(--border-color);
        margin: 8px 0;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideInTop {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to { opacity: 1; transform: translate(-50%, 0); }
    }

    @media (max-width: 734px) {
      body {
        padding: 16px;
        font-size: 16px;
      }
      
      .wrap {
        max-width: 100%;
        padding-top: 54px;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 22px;
      }
      
      .card {
        padding: 20px;
      }
      
      .actions {
        grid-template-columns: 1fr;
      }
      
      .actions button {
        width: 100%;
      }
      
      .popup-content {
        margin: 50px 0 0 0;
        padding: 16px;
        width: 100%;
        height: calc(100vh - 50px);
      }
      
      .edit-fields-row {
        flex-direction: column;
        gap: 0;
      }
      
      .edit-fields-row .campo {
        min-width: 100%;
      }
      
      input, select, textarea {
        padding: 16px;
      }
      
      .actions-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .actions-item {
        width: 100%;
        justify-content: flex-end;
      }
      
      .btn-list {
        position: sticky;
        bottom: 0;
        background: var(--bg-card);
        padding: 15px 0;
        margin-bottom: -10px;
      }
      
      .top-header {
        padding: 0 8px;
        height: 50px;
      }
      
      .top-header .left-icons {
        gap: 4px;
      }
      
      .top-header button {
        width: 32px;
        height: 32px;
        font-size: 16px;
        padding: 6px;
      }
    }

    .fornecedor-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .fornecedor-input-group input {
        flex: 1;
    }

    .manage-section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        padding: 0;
        color: var(--text-dark);
    }
    
    #lista-fornecedores-manage {
        margin-top: 20px;
        padding-top: 10px;
        border-top: 1px solid var(--border-color);
    }
    
    #lista-fornecedores-manage li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-dark);
        transition: background 0.2s ease;
    }
    
    #lista-fornecedores-manage li:hover {
        background: var(--border-color);
    }

    #lista-fornecedores-manage button {
        background: none;
        border: none;
        color: var(--button-danger);
        font-size: 16px;
        cursor: pointer;
        padding: 0;
    }
    
  </style>
</head>
<body>
  
  <header class="top-header">
    <div class="left-icons">
      <button id="fornecedores-btn" onclick="openPopup('fornecedores-popup')" title="Fornecedores"><i class="fas fa-truck"></i></button>
      <button id="pedidos-btn" onclick="openPopup('pedidos-popup')" title="Pedidos"><i class="fas fa-box"></i></button>
      <button id="historico-btn" onclick="openPopup('historico-popup')" title="Histórico"><i class="fas fa-history"></i></button>
      <button id="gerenciar-btn-top" onclick="openPopup('gerenciar-notas-popup')" title="Gerenciar Notas"><i class="fas fa-list-check"></i></button>
    </div>
    <div class="right-icons">
      <button id="theme-toggle" onclick="toggleTheme()" title="Alternar tema"><i class="fas fa-moon"></i></button>
    </div>
  </header>
  
  <div class="wrap">
    <h1>Relação de Notas Fiscais</h1>

    <div class="card">
      <div class="campo">
        <label for="data">Data</label>
        <div class="data-container">
          <input type="text" id="data" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" />
        </div>
      </div>

      <div class="campo">
        <label for="nf">NF</label>
        <input type="text" id="nf" inputmode="numeric" placeholder="Número da Nota Fiscal" autocomplete="off" />
      </div>

      <div class="campo">
        <label for="venc">Vencimento</label>
        <div class="data-container">
          <input type="text" id="venc" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" />
        </div>
      </div>

      <div class="campo">
        <label for="valor">Valor Total</label>
        <input id="valor" type="text" inputmode="decimal" pattern="[0-9.,]*" placeholder="Ex.: 1.200,50" />
      </div>

      <div class="campo">
        <label for="forn">Nome do Fornecedor</label>
        <input type="text" id="forn" placeholder="Nome do fornecedor" autocomplete="off" list="fornecedores-sugeridos" />
        <datalist id="fornecedores-sugeridos"></datalist>
      </div>

      <div class="campo">
        <label for="obs">Observações</label>
        <select id="obs">
          <option value="">Recurso a ser pago</option>
          <option value="C/C CTI">C/C CTI</option>
          <option value="C/C SANTA CASA">C/C SANTA CASA</option>
          <option value="Recurso Proprio Santa Casa">Recurso Proprio Santa Casa</option>
          <option value="Recurso Proprio CTI">Recurso Proprio CTI</option>
          <option value="PAGO">PAGO</option>
        </select>
      </div>
      
      <div class="campo">
        <label for="fotos">Anexar Imagens</label>
        <label for="fotos" class="file-input-label">
          <i class="fas fa-camera"></i> Selecionar Imagens
        </label>
        <input type="file" id="fotos" multiple accept="image/*" />
        <div class="status-container">
            <span class="hint" id="fileCountHint">Nenhuma imagem acumulada.</span>
        </div>
        <div id="miniaturas-container"></div>
      </div>

      <div class="actions">
        <button id="salvarBtn" onclick="salvarNota()"><i class="fas fa-check"></i> Salvar</button>
        <button id="exportBtn" onclick="exportar()"><i class="fas fa-clipboard"></i> Copiar</button>
        <button id="limparBtn" onclick="limpar()"><i class="fas fa-trash"></i> Limpar</button>
        <button id="gerenciarBtn" class="full-width" onclick="openPopup('gerenciar-notas-popup')"><i class="fas fa-list-check"></i> Gerenciar Notas</button>
      </div>

      <textarea id="saida" readonly placeholder="O texto para sua planilha aparecerá aqui..."></textarea>
    </div>

    <footer>
      <span>— Desenvolvido por <b>Leandro Mendonça</b> —</span>
    </footer>
  </div>
  
  <div id="gerenciar-notas-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Gerenciar Notas</h2>
        <span class="close-popup" onclick="closePopup('gerenciar-notas-popup')">&times;</span>
      </div>
      <div class="menu-section">
        <ul id="lista-notas-pendentes"></ul>
        <div class="paginacao" id="paginacao-notas"></div>
      </div>
    </div>
  </div>

  <div id="historico-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Histórico</h2>
        <span class="close-popup" onclick="closePopup('historico-popup')">&times;</span>
      </div>
      <div class="menu-section">
        <ul id="lista-historico" class="menu-list"></ul>
        <div class="paginacao" id="paginacao-historico"></div>
        <div class="btn-list">
          <button class="destructive" onclick="limparHistorico()"><i class="fas fa-trash-alt"></i> Limpar Histórico</button>
        </div>
      </div>
    </div>
  </div>

  <div id="pedidos-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Pedidos & Recursos</h2>
        <span class="close-popup" onclick="closePopup('pedidos-popup')">&times;</span>
      </div>
      <div class="menu-section">
        <div class="pedido-container">
          <input type="text" id="pedido-num" placeholder="Nº do Pedido" autocomplete="off">
          <select id="pedido-recurso">
            <option value="">Recurso...</option>
            <option value="Santa Casa">Santa Casa</option>
            <option value="CTI">CTI</option>
          </select>
        </div>
        <button class="actions-button" style="background: var(--button-primary); color: white; width: 100%; border: none; padding: 12px; border-radius: var(--radius);" onclick="adicionarPedido()"><i class="fas fa-plus"></i> Adicionar Pedido</button>
        <ul id="lista-pedidos"></ul>
      </div>
    </div>
  </div>
  
  <div id="fornecedores-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header">
        <h2>Fornecedores</h2>
        <span class="close-popup" onclick="closePopup('fornecedores-popup')">&times;</span>
      </div>
      <div class="menu-section">
        <h3 class="manage-section-title">Adicionar Novo Fornecedor</h3>
        <div class="fornecedor-input-group">
          <input type="text" id="forn-manage" placeholder="Nome do fornecedor">
          <button class="actions-button" style="background: var(--button-primary); color: white; border: none; padding: 10px 15px; border-radius: 8px;" onclick="adicionarFornecedorManage()"><i class="fas fa-plus"></i></button>
        </div>
        <ul id="lista-fornecedores-manage"></ul>
      </div>
    </div>
  </div>
  
  <div id="modalPreview" class="modal-preview">
    <span class="modal-preview-fechar" onclick="fecharPreview()">&times;</span>
    <img class="modal-preview-conteudo" id="imgPreview">
    <div class="modal-preview-nav">
        <button id="prevBtn" onclick="navegarFotos(-1)"><i class="fas fa-chevron-left"></i></button>
        <button id="nextBtn" onclick="navegarFotos(1)"><i class="fas fa-chevron-right"></i></button>
    </div>
    <div class="modal-preview-bottom">
      <button class="modal-preview-save" onclick="salvarFotoPreview()">
          <i class="fas fa-download"></i> Salvar Imagem
      </button>
      <button class="modal-preview-delete" onclick="excluirFotoPreview()">
          <i class="fas fa-trash-alt"></i> Excluir
      </button>
    </div>
  </div>

  <div id="toast" class="toast">✅ Linhas copiadas! Agora é só colar no Excel.</div>

<script>
  let linhas = [];
  let fotosAcumuladas = [];
  let notasPendentes = [];
  let historicoNotas = [];
  let fornecedoresSugeridos = [];
  let pedidosRecursos = {};
  let fotoAtualIndex = 0;
  let fotoAtualFonte = 'acumulada'; // 'acumulada' ou 'nota'
  let fotoAtualNotaIndex = null;
  
  const itensPorPagina = 10;
  let paginaAtualNotas = 1;
  let paginaAtualHistorico = 1;
  
  const dataEl = document.getElementById('data');
  const nfEl = document.getElementById('nf');
  const vencEl = document.getElementById('venc');
  const valorEl = document.getElementById('valor');
  const fornEl = document.getElementById('forn');
  const obsEl = document.getElementById('obs');
  const saidaEl = document.getElementById('saida');
  const fotosEl = document.getElementById('fotos');
  const fileLabelEl = document.querySelector('.file-input-label');
  const fileCountHintEl = document.getElementById('fileCountHint');
  const miniaturasContainer = document.getElementById('miniaturas-container');
  
  const listaNotasPendentes = document.getElementById('lista-notas-pendentes');
  const paginacaoNotasEl = document.getElementById('paginacao-notas');
  const paginacaoHistoricoEl = document.getElementById('paginacao-historico');
  const obsOptions = Array.from(obsEl.options).map(o => o.value);
  const fornDatalist = document.getElementById('fornecedores-sugeridos');
  
  const listaHistoricoEl = document.getElementById('lista-historico');
  const listaPedidosEl = document.getElementById('lista-pedidos');
  const listaFornManageEl = document.getElementById('lista-fornecedores-manage');
  const fornManageInput = document.getElementById('forn-manage');
  const pedidoNumInput = document.getElementById('pedido-num');
  const pedidoRecursoSelect = document.getElementById('pedido-recurso');
  
  const popups = document.querySelectorAll('.popup-modal');

  async function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
      });
  }

  async function dataURLtoFile(dataurl, filename) {
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) {
          u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], filename, { type: mime });
  }

  async function carregarEstado() {
      const savedForn = localStorage.getItem('fornecedores');
      if (savedForn) fornecedoresSugeridos = JSON.parse(savedForn);
      popularDatalist(fornDatalist);
      
      const savedHistorico = localStorage.getItem('historicoNotas');
      if (savedHistorico) historicoNotas = JSON.parse(savedHistorico);
      
      const savedPedidos = localStorage.getItem('pedidosRecursos');
      if (savedPedidos) pedidosRecursos = JSON.parse(savedPedidos);

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
          document.body.classList.add('dark-mode');
          document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>';
      }
      
      const savedNotasPendentes = localStorage.getItem('notasPendentes');
      if (savedNotasPendentes) {
          const loadedNotas = JSON.parse(savedNotasPendentes);
          notasPendentes = await Promise.all(loadedNotas.map(async nota => {
              if (nota.fotosBase64) {
                  nota.fotos = await Promise.all(nota.fotosBase64.map((base64, i) => dataURLtoFile(base64, `foto-${i}.jpg`)));
                  delete nota.fotosBase64;
              } else {
                  nota.fotos = [];
              }
              return nota;
          }));
      }
      
      rebuildNotasPendentesList();
      rebuildSaida();
  }
  
  async function salvarEstado() {
    const notasParaSalvar = await Promise.all(notasPendentes.map(async nota => {
        const notaSalvar = { ...nota, fotos: undefined }; // Evitar loop de serialização
        if (nota.fotos && nota.fotos.length > 0) {
            notaSalvar.fotosBase64 = await Promise.all(nota.fotos.map(file => fileToDataURL(file)));
        }
        return notaSalvar;
    }));
    
    localStorage.setItem('notasPendentes', JSON.stringify(notasParaSalvar));
    localStorage.setItem('fornecedores', JSON.stringify(fornecedoresSugeridos));
    localStorage.setItem('historicoNotas', JSON.stringify(historicoNotas));
    localStorage.setItem('pedidosRecursos', JSON.stringify(pedidosRecursos));
  }
  
  function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const isDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
    document.getElementById('theme-toggle').innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
  }

  function adicionarFornecedor(forn) {
      const fornUpper = forn.trim().toUpperCase();
      if (fornUpper && !fornecedoresSugeridos.includes(fornUpper)) {
          fornecedoresSugeridos.push(fornUpper);
          salvarEstado();
          popularDatalist(fornDatalist);
      }
  }

  function popularDatalist(datalistEl) {
      datalistEl.innerHTML = '';
      fornecedoresSugeridos.forEach(forn => {
          const option = document.createElement('option');
          option.value = forn;
          datalistEl.appendChild(option);
      });
  }

  function popularListaHistorico(pagina = 1) {
    listaHistoricoEl.innerHTML = '';
    paginaAtualHistorico = pagina;
    
    const inicio = (pagina - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const notasPagina = historicoNotas.slice(inicio, fim);
    
    if (notasPagina.length === 0 && pagina === 1) {
      listaHistoricoEl.innerHTML = '<li class="nota-item">Nenhuma nota no histórico.</li>';
    } else {
      notasPagina.forEach(nota => {
        const li = document.createElement('li');
        const dataFormatada = nota.data ? nota.data.slice(0, 5) : 's/data';
        li.textContent = `${nota.fornecedor} - ${nota.nf || 's/NF'} (${dataFormatada})`;
        li.classList.add('nota-item');
        listaHistoricoEl.appendChild(li);
      });
    }
    
    criarPaginacao(paginacaoHistoricoEl, historicoNotas.length, pagina, 'historico');
  }

  function popularListaPedidos() {
    listaPedidosEl.innerHTML = '';
    const sortedPedidos = Object.keys(pedidosRecursos).sort((a, b) => a - b);
    sortedPedidos.forEach(pedido => {
      const li = document.createElement('li');
      li.innerHTML = `${pedido} - ${pedidosRecursos[pedido]} <button onclick="deletarPedido('${pedido}')"><i class="fas fa-times-circle"></i></button>`;
      listaPedidosEl.appendChild(li);
    });
  }

  function popularListaFornecedores() {
    listaFornManageEl.innerHTML = '';
    fornecedoresSugeridos.sort().forEach(forn => {
      const li = document.createElement('li');
      li.innerHTML = `${forn} <button onclick="deletarFornecedor('${forn}')"><i class="fas fa-times-circle"></i></button>`;
      listaFornManageEl.appendChild(li);
    });
  }

  function criarPaginacao(container, totalItens, paginaAtual, tipo) {
    container.innerHTML = '';
    const totalPaginas = Math.ceil(totalItens / itensPorPagina);
    
    if (totalPaginas <= 1) return;
    
    if (paginaAtual > 1) {
      const btnAnterior = document.createElement('button');
      btnAnterior.innerHTML = '&laquo;';
      btnAnterior.addEventListener('click', () => {
        if (tipo === 'notas') {
          rebuildNotasPendentesList(paginaAtual - 1);
        } else {
          popularListaHistorico(paginaAtual - 1);
        }
      });
      container.appendChild(btnAnterior);
    }
    
    for (let i = 1; i <= totalPaginas; i++) {
      const btnPagina = document.createElement('button');
      btnPagina.textContent = i;
      if (i === paginaAtual) {
        btnPagina.classList.add('ativo');
      }
      btnPagina.addEventListener('click', () => {
        if (tipo === 'notas') {
          rebuildNotasPendentesList(i);
        } else {
          popularListaHistorico(i);
        }
      });
      container.appendChild(btnPagina);
    }
    
    if (paginaAtual < totalPaginas) {
      const btnProximo = document.createElement('button');
      btnProximo.innerHTML = '&raquo;';
      btnProximo.addEventListener('click', () => {
        if (tipo === 'notas') {
          rebuildNotasPendentesList(paginaAtual + 1);
        } else {
          popularListaHistorico(paginaAtual + 1);
        }
      });
      container.appendChild(btnProximo);
    }
  }

  function animateButton(btn, newText, newIconClass, originalText) {
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `<i class="${newIconClass}"></i> ${newText}`;
    setTimeout(() => {
      btn.innerHTML = originalHTML;
    }, 1500);
  }
  function fmtData(iso) {
    if (!iso) return '';
    return iso;
  }
  function getLinha(nota) {
    return [
      fmtData(nota.data), nota.nf, fmtData(nota.vencimento), nota.valor, "", nota.fornecedor, "", "", nota.obs
    ].join("\t");
  }
  function rebuildSaida() {
      linhas.length = 0;
      notasPendentes.forEach(nota => {
          linhas.push(getLinha(nota));
      });
      saidaEl.value = linhas.join("\n");
  }
  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display='none', 2200);
  }
  
  function formatarData(input) {
    let value = input.value.replace(/\D/g, '');
    let formattedValue = '';
    
    if (value.length > 0) {
      formattedValue += value.substring(0, 2);
    }
    if (value.length > 2) {
      formattedValue += '/' + value.substring(2, 4);
    }
    if (value.length > 4) {
      formattedValue += '/' + value.substring(4, 8);
    }
    input.value = formattedValue;
  }
  
  function rebuildNotasPendentesList(pagina = 1) {
    listaNotasPendentes.innerHTML = '';
    paginaAtualNotas = pagina;
    
    const inicio = (pagina - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const notasPagina = notasPendentes.slice(inicio, fim);
    
    if (notasPendentes.length === 0) {
        listaNotasPendentes.innerHTML = `<li class="nota-item">Nenhuma nota salva para gerenciar.</li>`;
        paginacaoNotasEl.innerHTML = '';
        return;
    }
    
    notasPagina.forEach((nota, index) => {
      const globalIndex = inicio + index;
      const li = document.createElement('li');
      li.classList.add('nota-item');
      if (nota.enviada) li.classList.add('nota-enviada');
      
      li.innerHTML = `
        <div class="nota-info">${nota.fornecedor} ${nota.nf || ''}
          ${nota.enviada ? '<i class="fas fa-check-circle"></i>' : ''}
        </div>
        <div class="nota-detalhes">
          Venc: ${nota.vencimento || 'N/A'} | Valor: ${nota.valor || 'N/A'}
        </div>
        <div class="actions-row">
          <span></span>
          <div class="actions-item">
            ${nota.fotos.length > 0 ? 
              `<button class="whatsapp-btn" onclick="compartilharNota(${globalIndex})" title="Compartilhar via WhatsApp">
                <i class="fab fa-whatsapp"></i>
              </button>` : `<span class="sem-fotos">SEM FOTOS</span>`}
            <button class="edit-btn" onclick="toggleEditPanel(this, ${globalIndex})" title="Editar nota">
              <i class="fas fa-pen"></i>
            </button>
            <button class="delete-btn" onclick="deletarNota(${globalIndex})" title="Excluir nota">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
        <div class="edit-panel">
          <div class="edit-fields-row">
            <div class="campo">
                <label for="fornEdit-${globalIndex}">Fornecedor</label>
                <input type="text" id="fornEdit-${globalIndex}" value="${nota.fornecedor}" oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="campo">
                <label for="nfEdit-${globalIndex}">NF</label>
                <input type="text" id="nfEdit-${globalIndex}" value="${nota.nf}">
            </div>
            <div class="campo">
                <label for="vencEdit-${globalIndex}">Vencimento</label>
                <input type="text" id="vencEdit-${globalIndex}" value="${nota.vencimento}">
            </div>
          </div>
          <div class="edit-fields-row">
            <div class="campo" style="flex:1;">
                <label for="valorEdit-${globalIndex}">Valor</label>
                <input type="text" id="valorEdit-${globalIndex}" value="${nota.valor}">
            </div>
            <div class="campo" style="flex:1;">
                <label for="obsEdit-${globalIndex}">Observações</label>
                <select id="obsEdit-${globalIndex}"></select>
            </div>
          </div>
          <div class="campo">
            <label for="edit-fotos-${globalIndex}">Anexar Imagens</label>
            <label for="edit-fotos-${globalIndex}" class="file-input-label">
              <i class="fas fa-camera"></i> Selecionar Imagens
            </label>
            <input type="file" id="edit-fotos-${globalIndex}" class="edit-file-input" multiple accept="image/*" />
            <div class="miniaturas-container-edit" id="miniaturas-container-edit-${globalIndex}"></div>
          </div>
          <div class="actions">
            <button style="background:var(--button-success);color:#fff; flex: 1;" onclick="salvarEdicao(${globalIndex})">
              <i class="fas fa-save"></i> Salvar
            </button>
          </div>
        </div>
      `;
      listaNotasPendentes.appendChild(li);

      const obsSelectEdit = li.querySelector(`#obsEdit-${globalIndex}`);
      obsOptions.forEach(option => {
          const optEl = document.createElement('option');
          optEl.value = option;
          optEl.textContent = option || 'Recurso a ser pago';
          obsSelectEdit.appendChild(optEl);
      });
      obsSelectEdit.value = nota.obs;

      const editFotosInput = li.querySelector(`#edit-fotos-${globalIndex}`);
      editFotosInput.addEventListener('change', async (e) => {
          const files = Array.from(e.target.files);
          notasPendentes[globalIndex].fotos = notasPendentes[globalIndex].fotos.concat(files);
          await salvarEstado();
          reconstruirMiniaturasEdit(globalIndex);
          rebuildNotasPendentesList(paginaAtualNotas);
      });
      reconstruirMiniaturasEdit(globalIndex);
    });
    
    criarPaginacao(paginacaoNotasEl, notasPendentes.length, pagina, 'notas');
  }
  
  function reconstruirMiniaturasEdit(globalIndex) {
      const container = document.getElementById(`miniaturas-container-edit-${globalIndex}`);
      const nota = notasPendentes[globalIndex];
      container.innerHTML = '';

      nota.fotos.forEach((file, i) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'miniatura-wrapper';
          
          const reader = new FileReader();
          reader.onload = (event) => {
              const img = document.createElement('img');
              img.src = event.target.result;
              img.onclick = () => abrirPreview(nota.fotos, i, globalIndex);
              
              const removeBtn = document.createElement('button');
              removeBtn.className = 'remove-foto';
              removeBtn.innerHTML = '×';
              removeBtn.onclick = async (e) => {
                  e.stopPropagation();
                  await removerFotoEdit(globalIndex, i);
              };
              
              wrapper.appendChild(img);
              wrapper.appendChild(removeBtn);
              container.appendChild(wrapper);
          };
          reader.readAsDataURL(file);
      });
  }

  async function removerFotoEdit(globalIndex, fotoIndex) {
      if (confirm("Remover esta imagem da nota?")) {
          notasPendentes[globalIndex].fotos.splice(fotoIndex, 1);
          reconstruirMiniaturasEdit(globalIndex);
          await salvarEstado();
          rebuildNotasPendentesList(paginaAtualNotas);
          toast("Imagem removida da nota.");
      }
  }

  function openPopup(idPopup) {
    const popup = document.getElementById(idPopup);
    if (popup) {
      document.body.classList.add('popup-open');
      popups.forEach(p => p.style.display = 'none');
      popup.style.display = 'flex';
      
      if (idPopup === 'gerenciar-notas-popup') {
        rebuildNotasPendentesList(1);
      } else if (idPopup === 'historico-popup') {
        popularListaHistorico(1);
      } else if (idPopup === 'pedidos-popup') {
        popularListaPedidos();
      } else if (idPopup === 'fornecedores-popup') {
        popularListaFornecedores();
      }
    }
  }

  function closePopup(idPopup) {
    const popup = document.getElementById(idPopup);
    if (popup) {
      popup.style.display = 'none';
      document.body.classList.remove('popup-open');
    }
  }

  function toggleEditPanel(btn, index) {
      const li = btn.closest('.nota-item');
      const panel = li.querySelector('.edit-panel');
      const allPanels = document.querySelectorAll('.edit-panel');
      
      allPanels.forEach(p => {
        if (p !== panel && p.classList.contains('show')) {
          p.classList.remove('show');
        }
      });
      panel.classList.toggle('show');
  }

  async function salvarEdicao(index) {
      const li = document.querySelectorAll('.nota-item')[index % itensPorPagina];
      const nota = notasPendentes[index];
      
      nota.fornecedor = li.querySelector(`#fornEdit-${index}`).value.trim().toUpperCase();
      nota.nf = li.querySelector(`#nfEdit-${index}`).value.trim();
      
      const vencimentoEditado = li.querySelector(`#vencEdit-${index}`).value.trim();
      nota.vencimento = vencimentoEditado;

      nota.valor = li.querySelector(`#valorEdit-${index}`).value.trim();
      nota.obs = li.querySelector(`#obsEdit-${index}`).value.trim();
      
      adicionarFornecedor(nota.fornecedor);

      rebuildSaida();
      await salvarEstado();
      toggleEditPanel(li.querySelector('.edit-btn'), index);
      rebuildNotasPendentesList(paginaAtualNotas);
      toast('✅ Nota editada e salva!');
  }

  async function deletarNota(index) {
    if (confirm("Tem certeza que deseja excluir esta nota?")) {
      notasPendentes.splice(index, 1);
      rebuildSaida();
      await salvarEstado();
      rebuildNotasPendentesList(paginaAtualNotas);
      toast("🗑️ Nota excluída!");
    }
  }

  async function exportar() {
    if (!saidaEl.value) {
      toast("Nada para copiar.");
      return;
    }
    
    try {
      await navigator.clipboard.writeText(saidaEl.value);
      toast("✅ Linhas copiadas! Agora é só colar no Excel.");
      const exportBtn = document.getElementById('exportBtn');
      animateButton(exportBtn, 'Copiado', 'fas fa-check', '<i class="fas fa-clipboard"></i> Copiar Texto');
    } catch {
      saidaEl.select();
      document.execCommand("copy");
      toast("✅ Linhas copiadas! Agora é só colar no Excel.");
    }
  }

  function limpar() {
    if (notasPendentes.length > 0) {
      historicoNotas = historicoNotas.concat(notasPendentes);
      notasPendentes = [];
      salvarEstado();
    }
    linhas.length = 0;
    saidaEl.value = "";
    fotosAcumuladas.length = 0;
    
    const camposEntrada = [dataEl, nfEl, vencEl, valorEl, fornEl, obsEl, fotosEl];
    camposEntrada.forEach(el => el.value = "");
    
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    dataEl.value = `${day}/${month}/${year}`;
    
    fileCountHintEl.textContent = 'Nenhuma imagem acumulada.';
    fileLabelEl.classList.remove('active');
    miniaturasContainer.innerHTML = '';
    rebuildNotasPendentesList(1);

    toast("Conteúdo limpo e histórico salvo.");
  }

  async function gerarImagemSeparadora(fornecedor, nf) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const width = 600;
      const height = 150;
      canvas.width = width;
      canvas.height = height;

      ctx.fillStyle = '#34495e';
      ctx.fillRect(0, 0, width, height);
      
      ctx.fillStyle = '#ecf0f1';
      ctx.font = 'bold 30px -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif';
      ctx.textAlign = 'center';
      
      const texto = `${fornecedor} ${nf}`;
      const marcador = `↓`;
      
      ctx.fillText(texto, width / 2, height / 2 - 10);
      
      ctx.font = '50px sans-serif';
      ctx.fillText(marcador, width / 2, height / 2 + 50);

      return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
  }

  async function compartilharNota(index) {
    try {
      if (!navigator.share) {
        toast("O compartilhamento de arquivos não é suportado pelo seu navegador.");
        return;
      }
      
      const nota = notasPendentes[index];
      const imagemSeparadora = await gerarImagemSeparadora(nota.fornecedor, nota.nf);
      const arquivosParaCompartilhar = [];
      
      arquivosParaCompartilhar.push(new File([imagemSeparadora], 'separador.png', { type: 'image/png' }));
      
      for (const foto of nota.fotos) {
        arquivosParaCompartilhar.push(foto);
      }
      
      const textoCompartilhar = `${nota.fornecedor} ${nota.nf || ''}`;
      
      if (navigator.canShare({ files: arquivosParaCompartilhar, text: textoCompartilhar })) {
        await navigator.share({
          files: arquivosParaCompartilhar,
          text: textoCompartilhar
        });
        
        notasPendentes[index].enviada = true;
        await salvarEstado();
        rebuildNotasPendentesList(paginaAtualNotas);
        toast("✅ Conteúdo enviado para o WhatsApp!");

      } else {
        toast("O compartilhamento de múltiplas fotos não é suportado pelo seu navegador.");
      }
    } catch (error) {
      console.error('Erro ao compartilhar:', error);
      toast("Erro ao compartilhar. Tente novamente.");
    }
  }

  function limparHistorico() {
    if (confirm("Tem certeza que deseja limpar todo o Histórico de notas? Esta ação não pode ser desfeita.")) {
      historicoNotas = [];
      salvarEstado();
      popularListaHistorico(1);
      toast("Histórico limpo com sucesso!");
    }
  }

  function adicionarPedido() {
    const pedidoNum = pedidoNumInput.value.trim();
    const recurso = pedidoRecursoSelect.value;
    if (pedidoNum && recurso) {
        pedidosRecursos[pedidoNum] = recurso;
        salvarEstado();
        popularListaPedidos();
        pedidoNumInput.value = '';
        pedidoRecursoSelect.value = '';
        toast(`Pedido ${pedidoNum} associado a ${recurso}!`);
    } else {
        toast('Preencha o número do pedido e selecione um recurso.');
    }
  }

  function deletarPedido(pedido) {
    if (confirm(`Tem certeza que deseja excluir o pedido ${pedido}?`)) {
      delete pedidosRecursos[pedido];
      salvarEstado();
      popularListaPedidos();
      toast(`Pedido ${pedido} excluído.`);
    }
  }

  function adicionarFornecedorManage() {
    const fornecedor = fornManageInput.value.trim();
    if (fornecedor) {
      adicionarFornecedor(fornecedor);
      popularListaFornecedores();
      fornManageInput.value = '';
      toast(`Fornecedor ${fornecedor.toUpperCase()} adicionado!`);
    } else {
      toast('Digite o nome do fornecedor.');
    }
  }

  function deletarFornecedor(forn) {
    if (confirm(`Tem certeza que deseja excluir o fornecedor ${forn}?`)) {
      fornecedoresSugeridos = fornecedoresSugeridos.filter(f => f !== forn);
      salvarEstado();
      popularDatalist(fornDatalist);
      popularListaFornecedores();
      toast(`Fornecedor ${forn} excluído.`);
    }
  }

  function removerFoto(index) {
    if (confirm("Remover esta imagem?")) {
      fotosAcumuladas.splice(index, 1);
      fileCountHintEl.textContent = `${fotosAcumuladas.length} imagem(ns) acumulada(s).`;
      
      reconstruirMiniaturas();
      
      if (fotosAcumuladas.length === 0) {
        fileLabelEl.classList.remove('active');
      }
    }
  }
  
  function reconstruirMiniaturas() {
      miniaturasContainer.innerHTML = '';
      fotosAcumuladas.forEach((file, i) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'miniatura-wrapper';
        
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.onclick = () => abrirPreview(fotosAcumuladas, i, null);
          
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-foto';
          removeBtn.innerHTML = '×';
          removeBtn.onclick = (e) => {
            e.stopPropagation();
            removerFoto(i);
          };
          
          wrapper.appendChild(img);
          wrapper.appendChild(removeBtn);
          miniaturasContainer.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      });
  }

  function abrirPreview(fotos, index, notaIndex) {
    const modal = document.getElementById('modalPreview');
    const imgPreview = document.getElementById('imgPreview');
    fotoAtualIndex = index;
    fotoAtualNotaIndex = notaIndex;
    fotoAtualFonte = notaIndex !== null ? 'nota' : 'acumulada';
    
    const reader = new FileReader();
    reader.onload = (event) => {
        imgPreview.src = event.target.result;
        modal.style.display = 'flex';
    };
    reader.readAsDataURL(fotos[index]);

    document.getElementById('prevBtn').style.display = index > 0 ? 'block' : 'none';
    document.getElementById('nextBtn').style.display = index < fotos.length - 1 ? 'block' : 'none';
  }

  function fecharPreview() {
    const modal = document.getElementById('modalPreview');
    modal.style.display = 'none';
  }

  function navegarFotos(direcao) {
      const fotosAtivas = fotoAtualFonte === 'acumulada' ? fotosAcumuladas : notasPendentes[fotoAtualNotaIndex].fotos;
      let novoIndex = fotoAtualIndex + direcao;

      if (novoIndex >= 0 && novoIndex < fotosAtivas.length) {
          abrirPreview(fotosAtivas, novoIndex, fotoAtualNotaIndex);
      }
  }

  function salvarFotoPreview() {
      const img = document.getElementById('imgPreview');
      if (!img.src) {
          toast("Nenhuma imagem para salvar.");
          return;
      }
      
      const link = document.createElement('a');
      link.href = img.src;
      link.download = `nota_fiscal_${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      toast("Imagem salva com sucesso!");
  }

  async function excluirFotoPreview() {
      if (confirm("Tem certeza que deseja excluir esta imagem?")) {
          if (fotoAtualFonte === 'acumulada') {
              fotosAcumuladas.splice(fotoAtualIndex, 1);
              fileCountHintEl.textContent = `${fotosAcumuladas.length} imagem(ns) acumulada(s).`;
              reconstruirMiniaturas();
              if (fotosAcumuladas.length === 0) {
                  fecharPreview();
              } else {
                  let novoIndex = fotoAtualIndex >= fotosAcumuladas.length ? fotosAcumuladas.length - 1 : fotoAtualIndex;
                  abrirPreview(fotosAcumuladas, novoIndex, null);
              }
          } else if (fotoAtualFonte === 'nota') {
              notasPendentes[fotoAtualNotaIndex].fotos.splice(fotoAtualIndex, 1);
              await salvarEstado();
              rebuildNotasPendentesList(paginaAtualNotas);
              if (notasPendentes[fotoAtualNotaIndex].fotos.length === 0) {
                  fecharPreview();
              } else {
                  let novoIndex = fotoAtualIndex >= notasPendentes[fotoAtualNotaIndex].fotos.length ? notasPendentes[fotoAtualNotaIndex].fotos.length - 1 : fotoAtualIndex;
                  abrirPreview(notasPendentes[fotoAtualNotaIndex].fotos, novoIndex, fotoAtualNotaIndex);
              }
          }
          toast("Imagem excluída.");
      }
  }

  async function salvarNota() {
    const nota = {
        data: dataEl.value.trim(),
        nf: nfEl.value.trim(),
        vencimento: vencEl.value.trim(),
        valor: valorEl.value.trim(),
        fornecedor: fornEl.value.trim().toUpperCase(),
        obs: obsEl.value.trim(),
        fotos: fotosAcumuladas,
        enviada: false
    };

    if (!nota.fornecedor) {
        toast("O campo 'Nome do Fornecedor' é obrigatório.");
        return;
    }

    notasPendentes.push(nota);
    fotosAcumuladas = [];
    
    rebuildSaida();
    await salvarEstado();
    rebuildNotasPendentesList(paginaAtualNotas);
    
    nfEl.value = "";
    vencEl.value = "";
    valorEl.value = "";
    fornEl.value = "";
    obsEl.value = "";
    
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    dataEl.value = `${day}/${month}/${year}`;

    fileCountHintEl.textContent = 'Nenhuma imagem acumulada.';
    fileLabelEl.classList.remove('active');
    miniaturasContainer.innerHTML = '';
    
    fornEl.focus();
    adicionarFornecedor(nota.fornecedor);
    toast("✅ Nota salva!");
  }


  document.addEventListener('DOMContentLoaded', () => {
      carregarEstado();
      const today = new Date();
      const day = String(today.getDate()).padStart(2, '0');
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const year = today.getFullYear();
      dataEl.value = `${day}/${month}/${year}`;
      
      document.getElementById('modalPreview').addEventListener('click', (e) => {
        if (e.target.id === 'modalPreview' || e.target.classList.contains('modal-preview-conteudo')) {
          fecharPreview();
        }
      });
      
      popups.forEach(popup => {
          popup.addEventListener('click', (e) => {
              if (e.target.classList.contains('popup-modal')) {
                  closePopup(popup.id);
              }
          });
      });
  });

  dataEl.addEventListener('input', (e) => {
    formatarData(e.target);
  });

  vencEl.addEventListener('input', (e) => {
    formatarData(e.target);
  });
  
  fornEl.addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });
  
  fornManageInput.addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });

  fornManageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      adicionarFornecedorManage();
    }
  });

  fotosEl.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      const newFiles = Array.from(e.target.files);
      fotosAcumuladas = fotosAcumuladas.concat(newFiles);
      fileCountHintEl.textContent = `${fotosAcumuladas.length} imagem(ns) acumulada(s).`;
      fileLabelEl.classList.add('active');
      reconstruirMiniaturas();
      
      e.target.value = "";
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
      e.preventDefault();
      const ordem = [dataEl, nfEl, vencEl, valorEl, fornEl, obsEl];
      const idx = ordem.indexOf(e.target);
      if (idx > -1 && idx < ordem.length - 1) {
        if (e.target === dataEl) {
          const dataCopiada = dataEl.value;
          vencEl.value = dataCopiada;
        }
        ordem[idx + 1].focus();
      } else if (e.target === obsEl) {
        salvarNota();
      }
    }
  });
</script>
</body>
</html>
