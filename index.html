<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no" />
  <title>Rela√ß√£o de Notas Fiscais</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Minhas Notas">
  <link rel="apple-touch-icon" href="favicon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Estilo Apple - Vari√°veis de cores e estilos */
    :root {
      --bg: #f5f5f7;
      --fg: #1d1d1f;
      --primary: #0071e3;
      --primary-dark: #006edb;
      --ok: #34c759;
      --ok-dark: #2c9e48;
      --muted: #86868b;
      --card: #ffffff;
      --border: #d2d2d7;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
      --whatsapp: #25D366;
      --radius: 12px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* Dark Mode */
    .dark-mode {
      --bg: #1c1c1e;
      --fg: #f5f5f7;
      --card: #2c2c2e;
      --border: #48484a;
      --muted: #8e8e93;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 15px;
      line-height: 1.47059;
      font-weight: 400;
      letter-spacing: -0.022em;
    }

    .wrap {
      max-width: 680px;
      margin: 0 auto;
    }

    h1 {
      margin: 0 0 28px;
      text-align: center;
      font-size: 28px;
      font-weight: 600;
      letter-spacing: -0.003em;
      color: var(--fg);
      animation: fadeInDown 0.6s ease;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px;
      animation: fadeInUp 0.6s ease;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
    }

    .campo {
      margin-bottom: 22px;
      position: relative;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 8px;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    /* Inputs no estilo Apple */
    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 15px;
      background: var(--card);
      transition: var(--transition);
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
      color: var(--fg);
    }

    input:hover, select:hover, textarea:hover {
      border-color: #a2a2a8;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
      outline: 0;
    }

    .dark-mode input, .dark-mode select, .dark-mode textarea {
      background: var(--card);
      color: var(--fg);
    }

    #forn, #fornEdit {
      text-transform: uppercase;
    }

    #forn::placeholder, #fornEdit::placeholder {
      text-transform: initial;
    }

    /* Estilo para sugest√µes (datalist) */
    input[list] {
      position: relative;
    }

    datalist {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding: 5px;
      color: var(--fg);
    }

    datalist option {
      padding: 10px;
      cursor: pointer;
    }

    /* Estilo do campo de fotos e miniaturas */
    .file-input-label {
      display: block;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      cursor: pointer;
      transition: var(--transition);
      font-size: 15px;
      color: var(--muted);
      text-align: center;
    }

    .file-input-label:hover {
      border-color: var(--primary);
      background: rgba(0, 123, 255, 0.04);
    }

    .file-input-label.active {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
    }

    .file-input-label i {
      margin-right: 8px;
      color: var(--primary);
    }

    #fotos {
      display: none;
    }

    #miniaturas-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    #miniaturas-container img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border);
      transition: var(--transition);
    }

    #miniaturas-container img:hover {
      transform: scale(1.05);
    }

    .status-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .status-container .hint {
      margin-top: 0;
    }

    /* Bot√µes com Estilo Apple */
    .actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .actions button {
      flex: 1;
      padding: 14px 20px;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
      letter-spacing: -0.01em;
      color: #fff;
    }

    button:active {
      transform: scale(0.98);
    }

    #salvarBtn {
      background: var(--ok);
    }

    #salvarBtn:hover {
      background: var(--ok-dark);
    }

    #gerenciarBtn {
      background: #515154;
    }

    #gerenciarBtn:hover {
      background: #424245;
    }

    #exportBtn {
      background: var(--primary);
    }

    #exportBtn:hover {
      background: var(--primary-dark);
    }

    #limparBtn {
      background: rgba(0, 0, 0, 0.04);
      color: var(--fg);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .dark-mode #limparBtn {
      color: #fff;
    }

    #limparBtn:hover {
      background: rgba(0, 0, 0, 0.08);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    #saida {
      width: 100%;
      height: 200px;
      margin-top: 22px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      padding: 16px;
      background: var(--bg);
      color: var(--fg);
      font-size: 13px;
      line-height: 1.4;
    }

    select {
      padding: 14px 16px;
    }

    /* Estilos do Modal (Pop-up) no estilo Apple */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: var(--card);
      margin: 10% auto;
      padding: 0;
      border-radius: 14px;
      max-width: 500px;
      position: relative;
      animation: slideInTop 0.3s;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .close {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      transition: color 0.2s;
      cursor: pointer;
    }
    
    .dark-mode .close {
      color: var(--muted);
    }

    .close:hover, .close:focus {
      color: var(--fg);
      text-decoration: none;
    }

    #lista-notas-pendentes {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nota-item {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      transition: var(--transition);
    }

    .nota-item:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .dark-mode .nota-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .nota-item:last-child {
      border-bottom: none;
    }

    .nota-info {
      font-weight: 500;
      font-size: 14px;
      color: var(--fg);
    }

    .nota-info span {
      font-weight: normal;
      font-size: 12px;
      color: var(--muted);
    }

    .nota-enviada .nota-info {
      color: var(--ok);
    }

    .nota-enviada .nota-info i {
      margin-left: 8px;
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .actions-item {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .actions-item button {
      height: 38px;
      width: 38px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: var(--bg);
      color: var(--fg);
      border: 1px solid var(--border);
    }

    .dark-mode .actions-item button {
      background: var(--card);
    }

    .actions-item .edit-btn, .actions-item .delete-btn {
      background: #f0f2f5;
      color: #5a6472;
      border: none;
    }
    .dark-mode .actions-item .edit-btn, .dark-mode .actions-item .delete-btn {
      background: #48484a;
      color: #d2d2d7;
    }

    .actions-item .edit-btn:hover, .actions-item .delete-btn:hover {
      background: #e0e2e5;
    }
    .dark-mode .actions-item .edit-btn:hover, .dark-mode .actions-item .delete-btn:hover {
      background: #58585a;
    }


    .actions-item .whatsapp-btn {
      background: var(--whatsapp);
      color: #fff;
    }

    .actions-item .whatsapp-btn:hover {
      background: #128C7E;
    }

    .actions-item i {
      font-size: 18px;
    }

    /* Estilos para o painel de edi√ß√£o */
    .edit-panel {
      display: none;
      padding: 15px;
      background-color: var(--bg);
      border-radius: 8px;
      margin-top: 10px;
      transition: all 0.3s ease-in-out;
    }

    .edit-panel.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    .edit-panel .campo {
      margin-bottom: 0;
    }

    .edit-fields-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .edit-fields-row .campo {
      flex: 1 1 30%;
    }

    .edit-fields-row input, .edit-fields-row select {
      padding: 10px;
      font-size: 13px;
    }

    /* Popup (toast) - Estilo Apple */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 14px 22px;
      border-radius: 12px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
      display: none;
      font-size: 14px;
      z-index: 9999;
      animation: toastIn 0.3s ease;
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
      font-weight: 400;
      letter-spacing: -0.01em;
    }

    /* Rodap√© */
    footer {
      margin-top: 28px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      letter-spacing: 0.4px;
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif;
    }

    footer b {
      font-weight: 600;
    }

    /* --- Estilos para o Menu Lateral Retr√°til (Hist√≥rico) --- */
    #sidebar-menu {
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      width: 280px;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      z-index: 1000;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%); /* Esconde o menu fora da tela */
      transition: transform 0.3s ease-in-out;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }

    .dark-mode #sidebar-menu {
      background-color: rgba(44, 44, 46, 0.9);
    }
    
    #sidebar-menu.show {
      transform: translateX(0); /* Move o menu para dentro da tela */
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      margin-bottom: 20px;
      position: relative;
    }

    #open-sidebar-btn {
      position: absolute;
      left: -52px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--primary);
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    #open-sidebar-btn:hover {
      transform: translateY(-50%) scale(1.05);
    }

    .dark-mode #open-sidebar-btn {
      background: var(--card);
    }
    
    #sidebar-title {
      font-size: 26px; /* T√≠tulo ajustado */
      font-weight: 700;
      letter-spacing: -0.015em;
      color: var(--fg);
      margin: 0;
    }

    .close-sidebar {
      font-size: 30px;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    
    .sidebar-section {
        margin-bottom: 20px;
        border-top: 1px solid var(--border);
        padding-top: 15px;
    }
    .sidebar-section h3 {
        margin: 0 0 10px;
        font-size: 16px;
        font-weight: 600;
    }
    
    .sidebar-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .sidebar-list li {
      padding: 12px 16px;
      border-radius: var(--radius);
      transition: var(--transition);
      cursor: pointer;
      color: var(--fg);
      font-size: 14px;
    }

    .sidebar-list li:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .dark-mode .sidebar-list li:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .sidebar-list li .meta {
      font-size: 12px;
      color: var(--muted);
    }
    .sidebar-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .sidebar-actions button {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        height: auto;
        border-radius: 8px;
    }
    #toggle-dark-mode-btn {
        background: var(--card);
        color: var(--fg);
        border: 1px solid var(--border);
    }
    .dark-mode #toggle-dark-mode-btn {
      background: var(--card);
      color: var(--fg);
    }

    /* Anima√ß√µes */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideInTop {
      from {
        transform: translateY(-30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translate(-50%, 20px);
      }
      to {
        opacity: 1;
        transform: translate(-50%, 0);
      }
    }

    @media (max-width: 734px) {
      body {
        padding: 16px;
        font-size: 16px;
      }
      
      .wrap {
        max-width: 100%;
      }
      
      h1 {
        font-size: 24px;
        margin-bottom: 22px;
      }
      
      .card {
        padding: 20px;
      }
      
      .actions {
        flex-direction: column;
      }
      
      .actions button {
        width: 100%;
      }
      
      .modal-content {
        margin: 20% 16px;
        width: auto;
      }
      
      .edit-fields-row {
        flex-direction: column;
        gap: 0;
      }
      
      input, select, textarea {
        padding: 16px;
      }

      #sidebar-menu {
        width: 100%;
      }
      #sidebar-menu.show {
        transform: translateX(0);
      }
      #open-sidebar-btn {
        top: 16px;
        left: 16px;
        transform: translateY(0%);
      }
    }
  </style>
</head>
<body>
  
  <aside id="sidebar-menu">
    <div class="sidebar-header">
      <h2 id="sidebar-title">Hist√≥rico</h2>
      <button id="open-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
      <button class="close-sidebar" onclick="toggleSidebar()">&times;</button>
    </div>
    
    <div class="sidebar-section">
      <h3>Pedidos & Recursos</h3>
      <div class="campo" style="margin-bottom: 10px;">
        <label for="pedido-num">N¬∫ do Pedido</label>
        <input type="text" id="pedido-num" placeholder="Ex: 1245">
      </div>
      <div class="campo" style="margin-bottom: 10px;">
        <label for="pedido-recurso">Recurso</label>
        <select id="pedido-recurso">
          <option value="">Selecione...</option>
          <option value="Santa Casa">Santa Casa</option>
          <option value="CTI">CTI</option>
        </select>
      </div>
      <button id="add-pedido-btn" class="actions-item" style="width: 100%; background: var(--ok); color: #fff; padding: 10px 15px; border-radius: var(--radius);"><i class="fas fa-plus"></i> Adicionar</button>
      <ul id="lista-pedidos" class="sidebar-list" style="margin-top: 10px;"></ul>
    </div>

    <div class="sidebar-section">
      <h3>Fornecedores</h3>
      <div class="campo" style="margin-bottom: 10px;">
        <label for="forn-manage">Gerenciar Fornecedores</label>
        <input type="text" id="forn-manage" placeholder="Adicionar novo fornecedor">
      </div>
      <ul id="lista-fornecedores-manage" class="sidebar-list"></ul>
    </div>

    <div class="sidebar-section">
      <h3>Op√ß√µes</h3>
      <div class="sidebar-actions">
          <button id="toggle-dark-mode-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i> Modo Escuro</button>
          <button id="export-backup-btn" class="actions-item" style="background: #515154; color: #fff;" onclick="exportData()"><i class="fas fa-file-export"></i> Backup</button>
          <button id="import-backup-btn" class="actions-item" style="background: var(--primary); color: #fff;" onclick="document.getElementById('file-input-backup').click()"><i class="fas fa-file-import"></i> Restaurar</button>
          <input type="file" id="file-input-backup" accept=".json" style="display:none;" onchange="importData(event)">
      </div>
    </div>
    
    <div class="sidebar-section" style="flex-grow: 1;">
      <h3>Notas no Hist√≥rico</h3>
      <ul id="lista-historico" class="sidebar-list"></ul>
      <div class="sidebar-actions">
        <button id="limpar-historico-btn" class="actions-item" style="background: #b33939; color: #fff;" onclick="limparHistorico()"><i class="fas fa-trash-alt"></i> Limpar Hist√≥rico</button>
      </div>
    </div>

  </aside>

  <div class="wrap">
    <h1>Rela√ß√£o de Notas Fiscais</h1>

    <div class="card">
      <div class="campo">
        <label for="data">Data</label>
        <div class="data-container">
          <input type="text" id="data" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" />
        </div>
      </div>

      <div class="campo">
        <label for="nf">NF</label>
        <input type="text" id="nf" inputmode="numeric" placeholder="N√∫mero da Nota Fiscal" autocomplete="off" />
      </div>

      <div class="campo">
        <label for="venc">Vencimento</label>
        <div class="data-container">
          <input type="text" id="venc" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" />
        </div>
      </div>

      <div class="campo">
        <label for="valor">Valor Total</label>
        <input id="valor" type="text" inputmode="decimal" pattern="[0-9.,]*" placeholder="Ex.: 1.200,50" />
      </div>

      <div class="campo">
        <label for="forn">Fornecedor</label>
        <input type="text" id="forn" placeholder="Nome do fornecedor" autocomplete="off" list="fornecedores-sugeridos" />
        <datalist id="fornecedores-sugeridos"></datalist>
      </div>

      <div class="campo">
        <label for="obs">Observa√ß√µes</label>
        <select id="obs">
          <option value="">Recurso a ser pago</option>
          <option value="C/C CTI">C/C CTI</option>
          <option value="C/C SANTA CASA">C/C SANTA CASA</option>
          <option value="Recurso Proprio Santa Casa">Recurso Proprio Santa Casa</option>
          <option value="Recurso Proprio CTI">Recurso Proprio CTI</option>
          <option value="PAGO">PAGO</option>
        </select>
      </div>
      
      <div class="campo">
        <label for="fotos">Anexar Imagens</label>
        <label for="fotos" class="file-input-label">
          <i class="fas fa-camera"></i> Selecionar Imagens
        </label>
        <input type="file" id="fotos" multiple accept="image/*" />
        <div class="status-container">
            <span class="hint" id="fileCountHint">Nenhuma imagem acumulada.</span>
        </div>
        <div id="miniaturas-container"></div>
      </div>

      <div class="actions">
        <button id="salvarBtn" onclick="salvarNota()"><i class="fas fa-check"></i> Salvar Nota</button>
        <button id="gerenciarBtn" onclick="abrirModalGerenciar()"><i class="fas fa-list-check"></i> Gerenciar Notas</button>
        <button id="exportBtn" onclick="exportar()"><i class="fas fa-clipboard"></i> Copiar Texto</button>
        <button id="limparBtn" onclick="limpar()"><i class="fas fa-trash"></i> Limpar Tudo</button>
      </div>

      <textarea id="saida" readonly placeholder="O texto para sua planilha aparecer√° aqui..."></textarea>
    </div>

    <footer>
      <span>‚Äî Desenvolvido por <b>Leandro Mendon√ßa</b> ‚Äî</span>
    </footer>
  </div>
  
  <div id="modalGerenciar" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Notas Salvas</h2>
        <span class="close" onclick="fecharModal('modalGerenciar')">&times;</span>
      </div>
      <ul id="lista-notas-pendentes"></ul>
      <p class="hint" style="text-align:center; margin-top: 20px; padding: 0 24px 20px;">Clique em "Compartilhar" para enviar individualmente.</p>
    </div>
  </div>

  <div id="toast" class="toast">‚úÖ Linhas copiadas! Agora √© s√≥ colar no Excel.</div>

<script>
  let linhas = [];
  let fotosAcumuladas = [];
  let notasPendentes = [];
  let historicoNotas = [];
  let fornecedoresSugeridos = [];
  let pedidosRecursos = {};
  
  // Elementos do DOM
  const dataEl = document.getElementById('data');
  const nfEl = document.getElementById('nf');
  const vencEl = document.getElementById('venc');
  const valorEl = document.getElementById('valor');
  const fornEl = document.getElementById('forn');
  const obsEl = document.getElementById('obs');
  const saidaEl = document.getElementById('saida');
  const fotosEl = document.getElementById('fotos');
  const fileLabelEl = document.querySelector('.file-input-label');
  const fileCountHintEl = document.getElementById('fileCountHint');
  const miniaturasContainer = document.getElementById('miniaturas-container');
  const modalGerenciar = document.getElementById('modalGerenciar');
  const listaNotasPendentes = document.getElementById('lista-notas-pendentes');
  const obsOptions = Array.from(obsEl.options).map(o => o.value);
  const fornDatalist = document.getElementById('fornecedores-sugeridos');
  const listaHistoricoEl = document.getElementById('lista-historico');
  const listaPedidosEl = document.getElementById('lista-pedidos');
  const listaFornManageEl = document.getElementById('lista-fornecedores-manage');
  const fornManageInput = document.getElementById('forn-manage');
  const addPedidoBtn = document.getElementById('add-pedido-btn');
  const pedidoNumInput = document.getElementById('pedido-num');
  const pedidoRecursoSelect = document.getElementById('pedido-recurso');
  
  // --- Fun√ß√µes de Estado (localStorage) ---
  function carregarEstado() {
      const savedForn = localStorage.getItem('fornecedores');
      if (savedForn) fornecedoresSugeridos = JSON.parse(savedForn);
      popularDatalist(fornDatalist);
      
      const savedHistorico = localStorage.getItem('historicoNotas');
      if (savedHistorico) historicoNotas = JSON.parse(savedHistorico);
      popularListaHistorico();
      
      const savedPedidos = localStorage.getItem('pedidosRecursos');
      if (savedPedidos) pedidosRecursos = JSON.parse(savedPedidos);
      popularListaPedidos();

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
          document.body.classList.add('dark-mode');
      }
  }

  function salvarEstado() {
      localStorage.setItem('fornecedores', JSON.stringify(fornecedoresSugeridos));
      localStorage.setItem('historicoNotas', JSON.stringify(historicoNotas));
      localStorage.setItem('pedidosRecursos', JSON.stringify(pedidosRecursos));
  }

  function adicionarFornecedor(forn) {
      const fornUpper = forn.trim().toUpperCase();
      if (fornUpper && !fornecedoresSugeridos.includes(fornUpper)) {
          fornecedoresSugeridos.push(fornUpper);
          salvarEstado();
          popularDatalist(fornDatalist);
          popularListaFornecedores();
      }
  }

  function popularDatalist(datalistEl) {
      datalistEl.innerHTML = '';
      fornecedoresSugeridos.forEach(forn => {
          const option = document.createElement('option');
          option.value = forn;
          datalistEl.appendChild(option);
      });
  }

  function popularListaHistorico() {
    listaHistoricoEl.innerHTML = '';
    historicoNotas.forEach(nota => {
      const li = document.createElement('li');
      li.textContent = `${nota.fornecedor} - ${nota.nf}`;
      li.classList.add('nota-item');
      listaHistoricoEl.appendChild(li);
    });
  }

  function popularListaPedidos() {
    listaPedidosEl.innerHTML = '';
    for (const pedido in pedidosRecursos) {
      const li = document.createElement('li');
      li.innerHTML = `Pedido **${pedido}**: ${pedidosRecursos[pedido]} <button onclick="deletarPedido('${pedido}')" style="background: none; border: none; color: #b33939; font-size: 14px;"><i class="fas fa-times-circle"></i></button>`;
      listaPedidosEl.appendChild(li);
    }
  }

  function popularListaFornecedores() {
    listaFornManageEl.innerHTML = '';
    fornecedoresSugeridos.forEach(forn => {
      const li = document.createElement('li');
      li.innerHTML = `${forn} <button onclick="deletarFornecedor('${forn}')" style="background: none; border: none; color: #b33939; font-size: 14px;"><i class="fas fa-times-circle"></i></button>`;
      listaFornManageEl.appendChild(li);
    });
  }

  // --- Fun√ß√µes de Anima√ß√£o e Utilit√°rias ---
  function animateButton(btn, newText, newIconClass, originalText) {
    const originalHTML = btn.innerHTML;
    btn.innerHTML = `<i class="${newIconClass}"></i> ${newText}`;
    setTimeout(() => {
      btn.innerHTML = originalHTML;
    }, 1500);
  }
  function fmtData(iso) {
    if (!iso) return '';
    return iso;
  }
  function getLinha(nota) {
    return [
      fmtData(nota.data), nota.nf, fmtData(nota.vencimento), nota.valor, "", nota.fornecedor, "", "", nota.obs
    ].join("\t");
  }
  function rebuildSaida() {
      linhas.length = 0;
      notasPendentes.forEach(nota => {
          linhas.push(getLinha(nota));
      });
      saidaEl.value = linhas.join("\n");
  }
  function toast(msg){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display = 'block';
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display='none', 2200);
  }
  
  function formatarData(input) {
    let value = input.value.replace(/\D/g, '');
    let formattedValue = '';
    
    if (value.length > 0) {
      formattedValue += value.substring(0, 2);
    }
    if (value.length > 2) {
      formattedValue += '/' + value.substring(2, 4);
    }
    if (value.length > 4) {
      formattedValue += '/' + value.substring(4, 8);
    }
    input.value = formattedValue;
  }

  // --- Fun√ß√µes Principais ---
  function salvarNota() {
    const fornecedor = fornEl.value.trim().toUpperCase();

    if (!fornecedor) {
      toast("Por favor, preencha o Fornecedor.");
      return;
    }
    
    adicionarFornecedor(fornecedor);

    const notaObj = {
      nf: nfEl.value.trim(),
      fornecedor: fornecedor,
      vencimento: vencEl.value.trim(),
      valor: valorEl.value.trim(),
      data: dataEl.value.trim(),
      obs: obsEl.value.trim(),
      fotos: fotosAcumuladas,
      enviada: false
    };
    notasPendentes.push(notaObj);

    rebuildSaida();

    const dataMantida = dataEl.value;
    [nfEl, vencEl, valorEl, fornEl, obsEl, fotosEl].forEach(el => el.value = "");
    fotosAcumuladas = [];
    dataEl.value = dataMantida;
    
    fileCountHintEl.textContent = 'Nenhuma imagem acumulada.';
    fileLabelEl.classList.remove('active');
    miniaturasContainer.innerHTML = '';
    
    toast("‚úÖ Nota salva! Agora voc√™ pode come√ßar a pr√≥xima.");
    nfEl.focus();
  }

  function abrirModalGerenciar() {
    if (notasPendentes.length === 0) {
        toast("Nenhuma nota salva para gerenciar.");
        return;
    }
    listaNotasPendentes.innerHTML = '';
    notasPendentes.forEach((nota, index) => {
      const li = document.createElement('li');
      li.classList.add('nota-item');
      if (nota.enviada) li.classList.add('nota-enviada');
      li.innerHTML = `
        <div class="actions-row">
          <span class="nota-info">${nota.fornecedor} ${nota.nf}
            ${nota.enviada ? '<i class="fas fa-check-circle"></i>' : ''}
          </span>
          <div class="actions-item">
            ${nota.fotos.length > 0 ? 
              `<button class="whatsapp-btn" onclick="compartilharNota(notasPendentes[${index}], ${index})">
                <i class="fab fa-whatsapp"></i>
              </button>` : `<span style="font-size:12px;color:var(--muted)">Sem fotos</span>`}
            <button class="edit-btn" onclick="toggleEditPanel(this, ${index})"><i class="fas fa-pen"></i></button>
            <button class="delete-btn" onclick="deletarNota(${index})"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="edit-panel">
          <div class="edit-fields-row">
            <div class="campo">
                <label for="fornEdit-${index}">Fornecedor</label>
                <input type="text" id="fornEdit-${index}" value="${nota.fornecedor}" list="fornecedores-sugeridos-edit">
            </div>
            <div class="campo">
                <label for="nfEdit-${index}">NF</label>
                <input type="text" id="nfEdit-${index}" value="${nota.nf}">
            </div>
            <div class="campo">
                <label for="vencEdit-${index}">Vencimento</label>
                <input type="text" id="vencEdit-${index}" value="${nota.vencimento}">
            </div>
          </div>
          <div class="edit-fields-row">
            <div class="campo" style="flex:1;">
                <label for="valorEdit-${index}">Valor</label>
                <input type="text" id="valorEdit-${index}" value="${nota.valor}">
            </div>
            <div class="campo" style="flex:1;">
                <label for="obsEdit-${index}">Observa√ß√µes</label>
                <select id="obsEdit-${index}"></select>
            </div>
          </div>
          <div class="actions">
            <button style="background:var(--ok);color:#fff; flex: 1;" onclick="salvarEdicao(${index})">
              <i class="fas fa-save"></i> Salvar
            </button>
          </div>
        </div>
      `;
      listaNotasPendentes.appendChild(li);
      
      const selectObs = li.querySelector(`#obsEdit-${index}`);
      obsOptions.forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val || 'Recurso a ser pago';
          selectObs.appendChild(opt);
      });
      selectObs.value = nota.obs;
    });
    modalGerenciar.style.display = 'block';
  }

  function toggleEditPanel(btn, index) {
      const li = btn.closest('.nota-item');
      const panel = li.querySelector('.edit-panel');
      const allPanels = document.querySelectorAll('.edit-panel');
      
      allPanels.forEach(p => {
        if (p !== panel && p.classList.contains('show')) {
          p.classList.remove('show');
        }
      });
      panel.classList.toggle('show');
  }

  function salvarEdicao(index) {
      const li = document.getElementById('lista-notas-pendentes').children[index];
      const nota = notasPendentes[index];
      
      nota.fornecedor = li.querySelector(`#fornEdit-${index}`).value.trim().toUpperCase();
      nota.nf = li.querySelector(`#nfEdit-${index}`).value.trim();
      
      const vencimentoEditado = li.querySelector(`#vencEdit-${index}`).value.trim();
      nota.vencimento = vencimentoEditado;

      nota.valor = li.querySelector(`#valorEdit-${index}`).value.trim();
      nota.obs = li.querySelector(`#obsEdit-${index}`).value.trim();
      
      adicionarFornecedor(nota.fornecedor);

      rebuildSaida();
      toggleEditPanel(li.querySelector('.edit-btn'), index);
      li.querySelector('.nota-info').innerHTML = `${nota.fornecedor} ${nota.nf}`;
      toast('‚úÖ Nota editada e salva!');
  }

  function deletarNota(index) {
    if (confirm("Tem certeza que deseja excluir esta nota?")) {
      notasPendentes.splice(index, 1);
      rebuildSaida();
      listaNotasPendentes.children[index].remove();
      toast("üóëÔ∏è Nota exclu√≠da!");
    }
  }

  function fecharModal(id) {
    document.getElementById(id).style.display = 'none';
  }

  async function exportar() {
    if (!saidaEl.value) {
      toast("Nada para copiar.");
      return;
    }
    
    try {
      await navigator.clipboard.writeText(saidaEl.value);
      toast("‚úÖ Linhas copiadas! Agora √© s√≥ colar no Excel.");
      const exportBtn = document.getElementById('exportBtn');
      animateButton(exportBtn, 'Copiado', 'fas fa-check', '<i class="fas fa-clipboard"></i> Copiar Texto');
    } catch {
      saidaEl.select();
      document.execCommand("copy");
      toast("‚úÖ Linhas copiadas! Agora √© s√≥ colar no Excel.");
    }
  }

  function limpar() {
    if (notasPendentes.length > 0) {
      historicoNotas = historicoNotas.concat(notasPendentes);
      notasPendentes = [];
      salvarEstado();
      popularListaHistorico();
      toast("üóëÔ∏è Notas movidas para o Hist√≥rico.");
    } else {
      toast("Nenhuma nota para limpar. Tudo pronto para come√ßar!");
    }
    linhas.length = 0;
    saidaEl.value = "";
    fotosAcumuladas.length = 0;
    
    const camposEntrada = [dataEl, nfEl, vencEl, valorEl, fornEl, obsEl, fotosEl];
    camposEntrada.forEach(el => el.value = "");
    
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    dataEl.value = `${day}/${month}/${year}`;
    
    fileCountHintEl.textContent = 'Nenhuma imagem acumulada.';
    fileLabelEl.classList.remove('active');
    miniaturasContainer.innerHTML = '';
    
    const limparBtn = document.getElementById('limparBtn');
    animateButton(limparBtn, 'Movido!', 'fas fa-check', '<i class="fas fa-trash"></i> Limpar Tudo');
  }

  async function gerarImagemSeparadora(fornecedor, nf) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const width = 600;
      const height = 150;
      canvas.width = width;
      canvas.height = height;

      ctx.fillStyle = '#0b1b31';
      ctx.fillRect(0, 0, width, height);
      
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 30px -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif';
      ctx.textAlign = 'center';
      
      const texto = `${fornecedor} ${nf}`;
      const marcador = `‚Üì`;
      
      ctx.fillText(texto, width / 2, height / 2 - 10);
      
      ctx.font = '50px sans-serif';
      ctx.fillText(marcador, width / 2, height / 2 + 50);

      return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
  }

  async function compartilharNota(nota, index) {
    try {
      if (!navigator.share) {
        toast("O compartilhamento de arquivos n√£o √© suportado pelo seu navegador.");
        return;
      }

      const imagemSeparadora = await gerarImagemSeparadora(nota.fornecedor, nota.nf);
      const arquivosParaCompartilhar = [];
      
      arquivosParaCompartilhar.push(new File([imagemSeparadora], 'separador.png', { type: 'image/png' }));
      
      for (const foto of nota.fotos) {
        arquivosParaCompartilhar.push(foto);
      }
      
      if (navigator.canShare({ files: arquivosParaCompartilhar })) {
        await navigator.share({
          files: arquivosParaCompartilhar,
        });
        
        notasPendentes[index].enviada = true;
        abrirModalGerenciar();
        toast("‚úÖ Conte√∫do enviado para o WhatsApp!");

      } else {
        toast("O compartilhamento de m√∫ltiplas fotos n√£o √© suportado pelo seu navegador.");
      }
    } catch (error) {
      console.error('Erro ao compartilhar:', error);
      toast("Erro ao compartilhar. Tente novamente.");
    }
  }
  
  // --- Novas Fun√ß√µes ---
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar-menu');
    sidebar.classList.toggle('show');
    if (sidebar.classList.contains('show')) {
      popularListaHistorico();
      popularListaFornecedores();
      popularListaPedidos();
    }
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    if (document.body.classList.contains('dark-mode')) {
      localStorage.setItem('theme', 'dark');
      document.getElementById('toggle-dark-mode-btn').innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
    } else {
      localStorage.setItem('theme', 'light');
      document.getElementById('toggle-dark-mode-btn').innerHTML = '<i class="fas fa-moon"></i> Modo Escuro';
    }
  }

  function limparHistorico() {
    if (confirm("Tem certeza que deseja limpar todo o Hist√≥rico de notas? Esta a√ß√£o n√£o pode ser desfeita.")) {
      historicoNotas = [];
      salvarEstado();
      popularListaHistorico();
      toast("Hist√≥rico limpo com sucesso!");
    }
  }

  function adicionarPedido() {
    const pedidoNum = pedidoNumInput.value.trim();
    const recurso = pedidoRecursoSelect.value;
    if (pedidoNum && recurso) {
        pedidosRecursos[pedidoNum] = recurso;
        salvarEstado();
        popularListaPedidos();
        pedidoNumInput.value = '';
        pedidoRecursoSelect.value = '';
        toast(`Pedido ${pedidoNum} associado a ${recurso}!`);
    } else {
        toast('Preencha o n√∫mero do pedido e selecione um recurso.');
    }
  }

  function deletarPedido(pedido) {
    if (confirm(`Tem certeza que deseja excluir o pedido ${pedido}?`)) {
      delete pedidosRecursos[pedido];
      salvarEstado();
      popularListaPedidos();
      toast(`Pedido ${pedido} exclu√≠do.`);
    }
  }

  function deletarFornecedor(forn) {
    if (confirm(`Tem certeza que deseja excluir o fornecedor ${forn}?`)) {
      fornecedoresSugeridos = fornecedoresSugeridos.filter(f => f !== forn);
      salvarEstado();
      popularDatalist(fornDatalist);
      popularListaFornecedores();
      toast(`Fornecedor ${forn} exclu√≠do.`);
    }
  }

  function exportData() {
    const data = {
      historicoNotas: historicoNotas,
      fornecedoresSugeridos: fornecedoresSugeridos,
      pedidosRecursos: pedidosRecursos
    };
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_notas_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    toast("Backup salvo com sucesso!");
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const importedData = JSON.parse(e.target.result);
        if (importedData.historicoNotas && importedData.fornecedoresSugeridos && importedData.pedidosRecursos) {
          historicoNotas = importedData.historicoNotas;
          fornecedoresSugeridos = importedData.fornecedoresSugeridos;
          pedidosRecursos = importedData.pedidosRecursos;
          salvarEstado();
          carregarEstado();
          toast("Dados restaurados com sucesso!");
        } else {
          toast("Arquivo de backup inv√°lido.");
        }
      } catch (error) {
        toast("Erro ao ler o arquivo de backup.");
      }
    };
    reader.readAsText(file);
  }

  // --- Inicializa√ß√£o e Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
      carregarEstado();
      const today = new Date();
      const day = String(today.getDate()).padStart(2, '0');
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const year = today.getFullYear();
      dataEl.value = `${day}/${month}/${year}`;
  });

  dataEl.addEventListener('input', (e) => {
    formatarData(e.target);
  });

  vencEl.addEventListener('input', (e) => {
    formatarData(e.target);
  });
  
  fornEl.addEventListener('input', (e) => {
    e.target.value = e.target.value.toUpperCase();
  });
  
  fotosEl.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      const newFiles = Array.from(e.target.files);
      fotosAcumuladas = fotosAcumuladas.concat(newFiles);
      fileCountHintEl.textContent = `${fotosAcumuladas.length} imagem(ns) acumulada(s).`;
      fileLabelEl.classList.add('active');
      newFiles.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
              const img = document.createElement('img');
              img.src = event.target.result;
              miniaturasContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
      });
      e.target.value = "";
    }
  });

  fornManageInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      adicionarFornecedor(e.target.value);
      e.target.value = '';
    }
  });

  addPedidoBtn.addEventListener('click', adicionarPedido);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
      e.preventDefault();
      const ordem = [dataEl, nfEl, vencEl, valorEl, fornEl, obsEl];
      const idx = ordem.indexOf(e.target);
      if (idx > -1 && idx < ordem.length - 1) {
        if (e.target === dataEl) {
          const dataCopiada = dataEl.value;
          vencEl.value = dataCopiada;
        }
        ordem[idx + 1].focus();
      } else if (e.target === obsEl) {
        salvarNota();
      }
    }
  });
</script>
</body>
</html>
