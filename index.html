<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Relação de Notas Fiscais</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Minhas Notas">
  <link rel="apple-touch-icon" href="favicon.png">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --bg-primary: #f0f2f5;
      --bg-card: #ffffff;
      --text-dark: #2c3e50;
      --text-light: #5e7280;
      --border-color: #e0e2e5;
      --button-primary: #3498db;
      --button-secondary: #95a5a6;
      --button-success: #2ecc71;
      --button-danger: #e74c4c;
      --button-whatsapp: #25D366; /* Cor do WhatsApp */
      --shadow: rgba(0, 0, 0, 0.1);
      --radius: 12px;
      --transition: all 0.3s ease;
      
      /* Novas cores para os botões e status */
      --button-save: #2ecc71; /* Verde - Salvar */
      --button-copy: #3498db; /* Azul - Copiar */
      --button-manage: #5e35b1; /* Roxo Escuro - Gerenciar Notas */
      --button-clean: #e74c4c; /* Vermelho - Limpar */
      --status-photos-sent: #2ecc71; /* Verde - Fotos Enviadas (correspondendo ao WhatsApp) */
      --bg-edit-panel: #f8f9fa; /* Fundo cinza claro para o painel de edição */
      
      /* Estilos para a notificação de fotos já enviadas */
      --sent-notification-bg: #ffffff; /* Fundo branco para a notificação */
      --sent-notification-text: #2ecc71; /* Texto verde para a notificação */
    }

    body.dark-mode {
      --bg-primary: #121212;
      --bg-card: #1e1e1e;
      --text-dark: #e0e0e0;
      --text-light: #a0a0a0;
      --border-color: #333;
      --shadow: rgba(255, 255, 255, 0.08);
      
      /* Novas cores para o modo escuro */
      --button-save: #2ecc71; 
      --button-copy: #4fa4e3;
      --button-manage: #8e62d3;
      --button-clean: #e74c4c;
      --status-photos-sent: #2ecc71;
      --bg-edit-panel: #2a2a2a;
      --sent-notification-bg: #1e1e1e; /* Fundo da notificação no modo escuro */
      --sent-notification-text: #2ecc71;
    }
    
    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    html, body {
      overscroll-behavior: auto;
      -webkit-tap-highlight-color: transparent;
      height: 100%;
    }

    body {
      margin: 0;
      padding: 24px;
      background: var(--bg-primary);
      color: var(--text-dark);
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      font-size: 15px;
      line-height: 1.47059;
      font-weight: 400;
      letter-spacing: -0.022em;
      transition: background var(--transition);
      touch-action: pan-x pan-y;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-text-size-adjust: none;
    }

    body.popup-open {
        overflow: hidden;
    }

    .wrap {
      max-width: 680px;
      margin: 0 auto;
      padding-top: 60px;
    }

    h1 {
      margin: 0 0 28px;
      text-align: center;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.003em;
      color: var(--text-dark);
      animation: fadeInDown 0.6s ease;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px var(--shadow);
      padding: 28px;
      animation: fadeInUp 0.6s ease;
      transition: var(--transition);
    }

    .card:hover {
      box-shadow: 0 8px 18px var(--shadow);
    }

    .campo {
      margin-bottom: 22px;
      position: relative;
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--text-light);
      margin: 0 0 8px;
      font-weight: 500;
      letter-spacing: -0.01em;
    }

    input, select, textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 15px;
      background: var(--bg-card);
      transition: var(--transition);
      font-family: inherit;
      color: var(--text-dark);
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--button-primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      outline: 0;
    }
    
    input:disabled, button:disabled {
        cursor: not-allowed;
        opacity: 0.7;
    }

    #forn, #fornEdit {
      text-transform: uppercase;
    }
    
    .valor-container {
        position: relative;
    }

    .valor-prefix {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
        pointer-events: none;
    }

    #valor, #valorEdit {
        padding-left: 16px;
    }
    
    .file-input-label {
      display: block;
      padding: 14px 16px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: var(--bg-card);
      cursor: pointer;
      transition: var(--transition);
      font-size: 15px;
      color: var(--text-light);
      text-align: center;
    }

    .file-input-label.disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .file-input-label:not(.disabled):hover {
      border-color: var(--button-primary);
      background: rgba(52, 152, 219, 0.04);
    }

    .file-input-label.active {
      border-color: var(--button-primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    .file-input-label i {
      margin-right: 8px;
      color: var(--button-primary);
    }

    #fotos, .edit-file-input {
      display: none;
    }

    #miniaturas-container, .miniaturas-container-edit {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .miniatura-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .miniatura-wrapper .not-found {
        width: 64px;
        height: 64px;
        border-radius: 8px;
        border: 1px dashed var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: var(--text-light);
        text-align: center;
        padding: 4px;
        background: var(--bg-primary);
    }
    
    .miniatura-wrapper .not-found i {
        font-size: 18px;
        margin-bottom: 4px;
        color: var(--text-light);
    }

    #miniaturas-container img, .miniaturas-container-edit img {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: var(--transition);
      cursor: pointer;
    }

    #miniaturas-container img:hover, .miniaturas-container-edit img:hover {
      transform: scale(1.05);
    }

    .remove-foto {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--button-danger);
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      cursor: pointer;
      border: none;
    }

    .status-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .status-container .hint {
      margin-top: 0;
    }
    
    .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 22px; 
    }

    .actions button {
      padding: 14px 20px;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      font-size: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
      letter-spacing: -0.01em;
      color: #fff;
    }
    
    #salvarBtn {
      background: var(--button-save); 
      color: #fff;
    }

    #salvarBtn:hover:not(:disabled) {
      opacity: 0.9;
    }

    #exportBtn, #shareListBtn {
      background: var(--button-copy);
      color: #fff;
    }

    #exportBtn:hover, #shareListBtn:hover {
      opacity: 0.9;
    }
    
    #limparBtn {
      background: var(--button-clean);
      color: #fff;
    }

    #limparBtn:hover {
      opacity: 0.9;
    }
    
    #gerenciarBtn {
      background: var(--button-manage);
      color: #fff;
    }

    #gerenciarBtn:hover {
      opacity: 0.9;
    }

    .hint {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 6px;
    }

    #saida {
      width: 100%;
      height: 200px;
      margin-top: 22px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      border: 1px dashed var(--border-color);
      border-radius: var(--radius);
      padding: 16px;
      background: var(--bg-primary);
      color: var(--text-dark);
      font-size: 13px;
      line-height: 1.4;
    }

    select {
      padding: 14px 16px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="rgb(44, 62, 80)" d="M7 10l5 5 5-5z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }
    
    body.dark-mode select {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="rgb(224, 224, 224)" d="M7 10l5 5 5-5z"/></svg>');
    }
    
    .popup-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s;
        overflow-y: auto;
    }
    
    .popup-content {
        background-color: var(--bg-card);
        padding: 24px;
        position: relative;
        animation: slideInTop 0.3s;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border-radius: 0;
        overflow-y: auto;
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
    }
    
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .popup-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }

    .close-popup {
        color: var(--text-light);
        font-size: 28px;
        font-weight: bold;
        transition: color 0.2s;
        cursor: pointer;
    }

    .close-popup, .modal-preview-fechar {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: transparent;
        border: none;
        padding: 0;
    }
    
    .close-popup:hover, .close-popup:focus {
        color: var(--text-dark);
        text-decoration: none;
    }
    
    #lista-notas-pendentes, #lista-historico, #lista-pedidos, #lista-fornecedores-manage, #lista-observacoes-manage {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nota-item {
      padding: 16px;
      margin-bottom: 10px;
      transition: var(--transition);
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px var(--shadow);
      border-radius: var(--radius);
    }

    .nota-item:hover {
      box-shadow: 0 4px 12px var(--shadow);
    }

    .nota-info {
      font-weight: 500;
      font-size: 14px;
      color: var(--text-dark);
      margin-bottom: 8px;
    }
    
    .nota-info b {
        font-weight: 700;
    }
    
    .nota-data {
        font-size: 12px;
        color: var(--text-light);
        font-weight: 400;
        margin-bottom: 8px;
    }

    .nota-detalhes {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 12px; /* Aumentado espaço para a barra de progresso */
    }
    
    .historico-detalhes {
      font-size: 12px;
      color: var(--text-light);
      margin-top: 8px;
    }

    .nota-enviada .nota-info {
      color: var(--button-success);
    }

    .nota-enviada .nota-info i {
      margin-left: 8px;
    }
    
    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    
    .actions-group {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions-row button {
      height: 38px;
      padding: 0 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-dark);
      border: 1px solid var(--border-color);
      transition: var(--transition);
      font-size: 13px; /* Tamanho da fonte ajustado */
      font-weight: 500;
    }

    .actions-row button.icon-only {
        width: 38px;
        padding: 0;
    }

    .actions-row button:hover {
      transform: scale(1.05);
    }

    .actions-row .whatsapp-btn {
      background: var(--button-whatsapp);
      color: #fff;
      border: none;
    }

    .actions-row .whatsapp-btn:hover {
      background: #128C7E;
    }

    .actions-row .edit-btn {
      color: var(--button-copy);
    }
    
    .actions-row .delete-btn {
      color: var(--button-danger);
    }

    .actions-row .sent-btn {
      background: var(--button-success);
      color: #fff;
      border: none;
      font-weight: bold;
    }
    
    .actions-row .sent-btn:hover {
      opacity: 0.9;
    }

    .actions-row i {
      font-size: 16px;
    }

    .sem-fotos {
      font-size: 12px;
      color: var(--text-light);
      padding: 4px 8px;
      background: var(--bg-primary);
      border-radius: 6px;
      margin-left: 8px;
      font-weight: 500;
    }

    .edit-panel {
      display: none;
      padding: 15px;
      background-color: var(--bg-edit-panel);
      border-radius: var(--radius);
      margin-top: 10px;
      transition: all 0.3s ease-in-out;
      overflow: visible;
    }

    .edit-panel.show {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    .edit-panel .campo {
      margin-bottom: 10px;
    }

    .edit-fields-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .edit-fields-row .campo {
      flex: 1 1 30%;
      min-width: 150px;
    }

    .edit-fields-row input, .edit-fields-row select {
      padding: 10px;
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
      background: var(--bg-card);
    }
    
    .edit-panel .actions {
        display: flex;
        justify-content: flex-end;
    }
    
    .edit-panel .actions button {
        flex: unset;
        width: auto;
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 32px;
      transform: translateX(-50%);
      background: rgba(44, 62, 80, 0.9);
      color: #fff;
      padding: 14px 22px;
      border-radius: 12px;
      box-shadow: 0 10px 28px rgba(0, 0, 0, 0.18);
      display: none;
      font-size: 14px;
      z-index: 9999;
      animation: toastIn 0.3s ease;
      font-family: inherit;
      font-weight: 400;
      letter-spacing: -0.01em;
    }

    footer {
      margin-top: 28px;
      text-align: center;
      color: var(--text-light);
      font-size: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
      letter-spacing: 0.4px;
      font-family: inherit;
    }

    footer b {
      font-weight: 600;
    }
    
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 54px;
      background-color: var(--bg-card);
      z-index: 1001;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      box-shadow: 0 2px 8px var(--shadow);
      transition: background var(--transition);
    }
    
    .top-header .left-icons {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .top-header .right-icons {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .top-header button {
      background: none;
      border: none;
      font-size: 18px;
      color: var(--text-light);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }

    .top-header button:hover {
      background: rgba(0, 0, 0, 0.05);
    }
    
    .top-header .logo {
        height: 24px;
        width: auto;
    }

    .top-header #theme-toggle i, .top-header #sync-btn i {
      transition: color 0.3s ease, transform 0.5s ease;
    }

    .top-header #sync-btn.syncing i {
        animation: fa-spin 1.5s linear infinite;
    }
    
    body.dark-mode .top-header button {
      color: var(--text-light);
    }
    
    .pedido-container {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .pedido-container input, .pedido-container select {
      flex: 1;
    }
    
    #lista-pedidos {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    #lista-pedidos li {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-dark);
    }
    
    #lista-pedidos button {
      background: none;
      border: none;
      color: var(--button-danger);
      font-size: 14px;
      cursor: pointer;
      padding: 0;
    }
    
    .paginacao {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      padding: 10px 0;
    }
    
    .paginacao button {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-card);
      color: var(--text-dark);
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .paginacao button:hover {
      background: var(--bg-primary);
    }
    
    .paginacao button.ativo {
      background: var(--button-primary);
      color: white;
      border-color: var(--button-primary);
    }
    
    .modal-preview {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      justify-content: center;
      align-items: center;
    }
    
    .modal-preview-conteudo {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    .modal-preview-fechar {
      position: fixed;
      top: 20px;
      right: 20px;
      color: white;
      font-size: 36px;
      background: rgba(0,0,0,0.5);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .modal-preview-fechar:hover {
      background: rgba(0,0,0,0.7);
    }

    .modal-preview-nav {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 10px;
    }

    .modal-preview-nav button {
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 10px;
        font-size: 24px;
        cursor: pointer;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        transition: background 0.2s;
    }

    .modal-preview-nav button:hover {
        background: rgba(0,0,0,0.7);
    }

    .modal-preview-bottom {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .modal-preview-delete {
      background: var(--button-danger);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-preview-save {
      background: var(--button-success);
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-list {
        margin-top: 15px;
        text-align: center;
        padding-bottom: 10px;
    }

    .btn-list button.destructive {
        background: var(--button-danger);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
    }
    
    .separator-line {
        height: 0.5px;
        background-color: var(--border-color);
        margin: 8px 0;
    }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideInTop { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes toastIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
    @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .fotos-enviadas-status { background: var(--sent-notification-bg); color: var(--sent-notification-text); font-weight: 600; text-align: center; padding: 12px 20px; border-radius: var(--radius); margin-top: 10px; }

    @media (max-width: 734px) {
      body { padding: 16px; font-size: 16px; } .wrap { max-width: 100%; padding-top: 54px; } h1 { font-size: 24px; margin-bottom: 22px; } .card { padding: 20px; } 
      .actions { grid-template-columns: 1fr; } 
      .actions button { width: 100%; } .popup-content { margin: 50px 0 0 0; padding: 16px; width: 100%; height: calc(100vh - 50px); } .edit-fields-row { flex-direction: column; gap: 0; }
      .edit-fields-row .campo { min-width: 100%; } input, select, textarea { padding: 16px; } 
      .actions-row { flex-direction: row; align-items: center; gap: 8px; } /* Ajuste para mobile */
      .actions-group { width: auto; justify-content: flex-end; } .btn-list { padding: 15px 0; } .top-header { padding: 0 8px; height: 50px; gap: 8px; }
      .top-header .left-icons, .top-header .right-icons { gap: 4px; flex-grow: 1; justify-content: flex-start; } .top-header .right-icons { justify-content: flex-end; }
      .top-header button { width: 32px; height: 32px; font-size: 16px; padding: 6px; }
    }

    .fornecedor-input-group, .observacoes-input-group { display: flex; gap: 10px; align-items: center; }
    .fornecedor-input-group input, .observacoes-input-group input { flex: 1; } .manage-section-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; padding: 0; color: var(--text-dark); }
    #lista-fornecedores-manage, #lista-observacoes-manage { margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--border-color); }
    #lista-fornecedores-manage li, #lista-observacoes-manage li { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius); margin-bottom: 8px; font-size: 14px; font-weight: 500; color: var(--text-dark); transition: background 0.2s ease; }
    #lista-fornecedores-manage li:hover, #lista-observacoes-manage li:hover { background: var(--border-color); }
    #lista-fornecedores-manage button, #lista-observacoes-manage button { background: none; border: none; color: var(--button-danger); font-size: 16px; cursor: pointer; padding: 0; }

    /* --- ESTILOS DO CHECKLIST --- */
    .checklist-container {
        display: none;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid var(--border-color);
        animation: fadeIn 0.2s ease; /* Animação mais rápida */
    }
    .checklist-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 14px;
    }
    .checklist-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 12px;
        cursor: pointer;
        accent-color: var(--button-primary);
    }
    .checklist-item label {
        margin: 0;
        font-weight: 400;
        color: var(--text-dark);
        cursor: pointer;
    }
    .progress-bar-container {
        width: 100%;
        background-color: var(--bg-primary);
        border-radius: 4px;
        height: 8px;
        margin-top: 4px;
        margin-bottom: 12px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background-color: var(--button-success);
        width: 0%;
        transition: width 0.5s ease;
    }
  </style>
</head>
<body>
  
  <header class="top-header">
    <div class="left-icons">
      <button onclick="togglePopup('fornecedores-popup')" title="Fornecedores"><i class="fas fa-truck"></i></button> <button onclick="togglePopup('pedidos-popup')" title="Pedidos"><i class="fas fa-box"></i></button> <button onclick="togglePopup('observacoes-popup')" title="Observações"><i class="fas fa-comment-dots"></i></button> <button onclick="togglePopup('gerenciar-notas-popup')" title="Gerenciar Notas"><i class="fas fa-list-check"></i></button> <button onclick="togglePopup('historico-popup')" title="Histórico"><i class="fas fa-history"></i></button>
    </div>
    <div class="right-icons"> <button id="sync-btn" onclick="sincronizarManualmente()" title="Sincronizar notas"><i class="fas fa-sync-alt"></i></button> <button id="theme-toggle" onclick="toggleTheme()" title="Alternar tema"><i class="fas fa-moon"></i></button> </div>
  </header>
  
  <div class="wrap">
    <h1>Relação de Notas Fiscais</h1>

    <div class="card">
      <div class="campo"> <label for="data">Data</label> <input type="text" id="data" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" /> </div>
      <div class="campo"> <label for="nf">NF</label> <input type="text" id="nf" inputmode="numeric" placeholder="Número da Nota Fiscal" autocomplete="off" /> </div>
      <div class="campo"> <label for="venc">Vencimento</label> <input type="text" id="venc" placeholder="dd/mm/aaaa" maxlength="10" inputmode="numeric" /> </div>
      <div class="campo"> <label for="valor">Valor Total</label> <input id="valor" type="text" inputmode="decimal" placeholder="Ex.: 1200,50" /> </div>
      <div class="campo"> <label for="forn">Nome do Fornecedor</label> <input type="text" id="forn" placeholder="Nome do fornecedor" autocomplete="off" list="fornecedores-sugeridos" /> <datalist id="fornecedores-sugeridos"></datalist> </div>
      <div class="campo"> <label for="obs">Observações</label> <select id="obs"></select> </div>
      <div id="fotos-container" class="campo">
        <label for="fotos">Anexar Imagens</label> <label for="fotos" class="file-input-label"><i class="fas fa-camera"></i> Selecionar Imagens</label> <input type="file" id="fotos" multiple accept="image/*" />
        <div class="status-container"> <span class="hint" id="fileCountHint">Nenhuma imagem acumulada.</span> </div> <div id="miniaturas-container"></div>
      </div>
      <div class="actions">
        <button id="salvarBtn" onclick="salvarNota()"><i class="fas fa-check"></i> Salvar</button>
        <button id="exportBtn" onclick="exportar()"><i class="fas fa-clipboard"></i> Copiar</button>
        <button id="shareListBtn" onclick="compartilharLista()"><i class="fas fa-share-alt"></i> Compartilhar</button>
        <button id="limparBtn" onclick="limpar()"><i class="fas fa-trash"></i> Limpar</button>
        <button id="gerenciarBtn" onclick="togglePopup('gerenciar-notas-popup')"><i class="fas fa-list-check"></i> Gerenciar Notas</button>
      </div>
      <textarea id="saida" readonly placeholder="O texto das notas salvas aparecerá aqui..."></textarea>
    </div>
    <footer> <span>— Desenvolvido por <b>Leandro Mendonça</b> —</span> </footer>
  </div>
  
  <div id="gerenciar-notas-popup" class="popup-modal">
    <div class="popup-content"> <div class="popup-header"> <h2>Gerenciar Notas</h2> <span class="close-popup" onclick="closePopup('gerenciar-notas-popup')">&times;</span> </div> <div class="menu-section"> <ul id="lista-notas-pendentes"></ul> <div class="paginacao" id="paginacao-notas"></div> </div> </div>
  </div>
  <div id="historico-popup" class="popup-modal">
    <div class="popup-content"> <div class="popup-header"> <h2>Histórico</h2> <span class="close-popup" onclick="closePopup('historico-popup')">&times;</span> </div> <div class="menu-section"> <ul id="lista-historico"></ul> <div class="btn-list"> <button class="destructive" onclick="limparHistorico()"><i class="fas fa-trash"></i> Limpar Histórico</button> </div> </div> </div>
  </div>
  <div id="pedidos-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header"> <h2>Pedidos & Recursos</h2> <span class="close-popup" onclick="closePopup('pedidos-popup')">&times;</span> </div>
      <div class="menu-section">
        <div class="pedido-container">
          <input type="text" id="pedido-num" placeholder="Nº do Pedido" autocomplete="off">
          <select id="pedido-recurso"> <option value="">Recurso...</option> <option value="Santa Casa">Santa Casa</option> <option value="CTI">CTI</option> </select>
        </div>
        <button class="actions-button" style="background: var(--button-primary); color: white; width: 100%; border: none; padding: 12px; border-radius: var(--radius);" onclick="adicionarPedido()"><i class="fas fa-plus"></i> Adicionar Pedido</button>
        <ul id="lista-pedidos"></ul>
      </div>
    </div>
  </div>
  <div id="fornecedores-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header"> <h2>Fornecedores</h2> <span class="close-popup" onclick="closePopup('fornecedores-popup')">&times;</span> </div>
      <div class="menu-section">
        <h3 class="manage-section-title">Adicionar Novo Fornecedor</h3>
        <div class="fornecedor-input-group"> <input type="text" id="forn-manage" placeholder="Nome do fornecedor"> <button class="actions-button" style="background: var(--button-primary); color: white; border: none; padding: 10px 15px; border-radius: 8px;" onclick="adicionarFornecedorManage()"><i class="fas fa-plus"></i></button> </div>
        <ul id="lista-fornecedores-manage"></ul>
      </div>
    </div>
  </div>
  <div id="observacoes-popup" class="popup-modal">
    <div class="popup-content">
      <div class="popup-header"> <h2>Observações e Recursos</h2> <span class="close-popup" onclick="closePopup('observacoes-popup')">&times;</span> </div>
      <div class="menu-section">
        <h3 class="manage-section-title">Adicionar Nova Observação</h3>
        <div class="observacoes-input-group"> <input type="text" id="obs-manage" placeholder="Ex: C/C UPA"> <button class="actions-button" style="background: var(--button-primary); color: white; border: none; padding: 10px 15px; border-radius: 8px;" onclick="adicionarObservacaoManage()"><i class="fas fa-plus"></i></button> </div>
        <ul id="lista-observacoes-manage"></ul>
      </div>
    </div>
  </div>
  <div id="modalPreview" class="modal-preview">
    <span class="modal-preview-fechar" onclick="fecharPreview()">&times;</span> <img class="modal-preview-conteudo" id="imgPreview">
    <div class="modal-preview-nav"> <button id="prevBtn" onclick="navegarFotos(-1)"><i class="fas fa-chevron-left"></i></button> <button id="nextBtn" onclick="navegarFotos(1)"><i class="fas fa-chevron-right"></i></button> </div>
    <div class="modal-preview-bottom"> <button class="modal-preview-save" onclick="salvarFotoPreview()"><i class="fas fa-download"></i> Salvar Imagem</button> <button class="modal-preview-delete" onclick="excluirFotoPreview()"><i class="fas fa-trash-alt"></i> Excluir</button> </div>
  </div>
  <div id="toast" class="toast"></div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  const firebaseConfig = { apiKey: "AIzaSyAwcvJNJhLZ4Wqcw4Wz44XJ9kIdtqKJeJg", authDomain: "relacaonf.firebaseapp.com", projectId: "relacaonf", storageBucket: "relacaonf.appspot.com", messagingSenderId: "773864981925", appId: "1:773864981925:web:a4dadc51ec0a856832144c" };
  firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();
  firestore.enablePersistence().catch(err => {
      if (err.code == 'failed-precondition') console.warn('Persistência do Firebase falhou: Múltiplas abas abertas.');
      else if (err.code == 'unimplemented') console.warn('Persistência do Firebase não suportada neste navegador.');
  });
  const notasCollection = firestore.collection('notas'), historicoCollection = firestore.collection('historico');
  let notasPendentes = [], historicoNotas = [], fotosAcumuladas = [], fornecedoresSugeridos = [], observacoesSugeridas = [], pedidosRecursos = {};
  let fotoAtualIndex = 0, fotoAtualFonte = 'acumulada', fotoAtualNotaIndex = null, fotosAtuaisParaPreview = [], idPainelEdicaoAberto = null;
  const itensPorPagina = 10;
  let paginaAtualNotas = 1;
  const dataEl = document.getElementById('data'), nfEl = document.getElementById('nf'), vencEl = document.getElementById('venc'), valorEl = document.getElementById('valor'), fornEl = document.getElementById('forn'), obsEl = document.getElementById('obs'), saidaEl = document.getElementById('saida'), fotosEl = document.getElementById('fotos'), fileLabelEl = document.querySelector('.file-input-label'), fileCountHintEl = document.getElementById('fileCountHint'), miniaturasContainer = document.getElementById('miniaturas-container'), listaNotasPendentes = document.getElementById('lista-notas-pendentes'), paginacaoNotasEl = document.getElementById('paginacao-notas'), listaHistoricoEl = document.getElementById('lista-historico'), fornDatalist = document.getElementById('fornecedores-sugeridos'), listaPedidosEl = document.getElementById('lista-pedidos'), listaFornManageEl = document.getElementById('lista-fornecedores-manage'), fornManageInput = document.getElementById('forn-manage'), pedidoNumInput = document.getElementById('pedido-num'), pedidoRecursoSelect = document.getElementById('pedido-recurso'), listaObservacoesManageEl = document.getElementById('lista-observacoes-manage'), obsManageInput = document.getElementById('obs-manage'), popups = document.querySelectorAll('.popup-modal');
  const DB_NAME = 'notasdb-fotos', DB_VERSION = 1;
  let db;

  // --- NOVA ESTRUTURA DE CHECKLIST ---
  const checklistDefinition = {
    tirarFoto: "Tirar Foto",
    entradaSistema: "Entrada no sistema",
    produtosTransferidos: "Produtos transferidos",
    fotosNoServidor: "Fotos no servidor",
    cotacaoNoServidor: "Cotação no Servidor",
    notaEscaneada: "Nota Escaneada",
    estaNaPlanilha: "Está na planilha",
    cotacaoAnexada: "Cotação Anexada",
    notaCarimbada: "Nota Carimbada"
  };

  // --- ESTADOS DA INTERFACE ---
  let openChecklistIds = new Set();
  let isChecklistUpdate = false; // Flag para controlar a atualização do checklist

  function openDB() { return new Promise((resolve, reject) => { const r = indexedDB.open(DB_NAME, DB_VERSION); r.onupgradeneeded = e => e.target.result.createObjectStore('fotos', { keyPath: 'id' }); r.onsuccess = e => { db = e.target.result; resolve(db); }; r.onerror = e => { console.error("Erro no IndexedDB:", e.target.errorCode); reject(e.target.errorCode); }; }); }
  function generateUniqueId() { return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; }
  function savePhotoDB(id, file) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); const tx = db.transaction(['fotos'], 'readwrite').objectStore('fotos').put({ id, file }); tx.onsuccess = () => resolve(id); tx.onerror = e => reject(e.target.error); }); }
  function getPhotoDB(id) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); const r = db.transaction(['fotos'], 'readonly').objectStore('fotos').get(id); r.onsuccess = () => resolve(r.result ? r.result.file : null); r.onerror = e => { console.error(`Erro ao buscar foto ${id}:`, e.target.error); reject(e.target.error); }; }); }
  function deletePhotoDB(id) { return new Promise(async (resolve, reject) => { if (!db) await openDB(); const tx = db.transaction(['fotos'], 'readwrite').objectStore('fotos').delete(id); tx.onsuccess = () => resolve(); tx.onerror = e => reject(e.target.error); }); }

  async function carregarEstado() {
      fornecedoresSugeridos = JSON.parse(localStorage.getItem('fornecedores') || '[]'), popularDatalist(fornDatalist);
      observacoesSugeridas = JSON.parse(localStorage.getItem('observacoes') || '[]'), popularObservacoesList();
      pedidosRecursos = JSON.parse(localStorage.getItem('pedidosRecursos') || '{}');
      if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-toggle').innerHTML = '<i class="fas fa-sun"></i>'; }
      try { await openDB(); } catch(e) { console.error("Não foi possível iniciar o DB de fotos.", e); toast("Erro ao carregar o armazenamento de fotos."); }
      
      notasCollection.orderBy('dataCriacao', 'desc').onSnapshot(snapshot => {
        // Lógica de atualização inteligente
        if (snapshot.metadata.hasPendingWrites && isChecklistUpdate) {
            isChecklistUpdate = false; // Reseta a flag
            notasPendentes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            saidaEl.value = buildSaidaText(); // Atualiza apenas o campo de saída
            return; // Pula o redesenho da lista
        }
        
        // Para outras mudanças (do servidor, ou adições/edições locais), redesenha tudo
        notasPendentes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        rebuildNotasPendentesList();
      }, error => { console.error("Erro ao carregar notas:", error); toast("Erro ao carregar dados. Verifique sua conexão."); });

      historicoCollection.orderBy('dataHistorico', 'desc').onSnapshot(snapshot => {
        historicoNotas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        popularListaHistorico();
      }, error => console.error("Erro ao carregar histórico:", error));
  }
  
  function salvarEstado() { localStorage.setItem('fornecedores', JSON.stringify(fornecedoresSugeridos)); localStorage.setItem('observacoes', JSON.stringify(observacoesSugeridas)); localStorage.setItem('pedidosRecursos', JSON.stringify(pedidosRecursos)); }
  function toggleTheme() { document.body.classList.toggle('dark-mode'); const isDark = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', isDark ? 'dark' : 'light'); document.getElementById('theme-toggle').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; }
  function adicionarFornecedor(forn) { const f = forn.trim().toUpperCase(); if (f && !fornecedoresSugeridos.includes(f)) { fornecedoresSugeridos.push(f); salvarEstado(); popularDatalist(fornDatalist); } }
  function adicionarObservacao(obs) { const o = obs.trim(); if (o && !observacoesSugeridas.includes(o)) { observacoesSugeridas.push(o); salvarEstado(); popularObservacoesList(); } }
  function popularDatalist(datalistEl) { datalistEl.innerHTML = ''; fornecedoresSugeridos.forEach(forn => { const o = document.createElement('option'); o.value = forn; datalistEl.appendChild(o); }); }

  function popularObservacoesList() {
    obsEl.innerHTML = '<option value="">Recurso a ser pago</option>';
    observacoesSugeridas.forEach(obs => obsEl.innerHTML += `<option value="${obs}">${obs}</option>`);
    listaObservacoesManageEl.innerHTML = '';
    observacoesSugeridas.sort().forEach(obs => { const li = document.createElement('li'); li.innerHTML = `${obs} <button onclick="deletarObservacao('${obs}')"><i class="fas fa-times-circle"></i></button>`; listaObservacoesManageEl.appendChild(li); });
  }

  function popularListaPedidos() {
    listaPedidosEl.innerHTML = '';
    Object.keys(pedidosRecursos).sort((a, b) => a - b).forEach(p => { const li = document.createElement('li'); li.innerHTML = `${p} - ${pedidosRecursos[p]} <button onclick="deletarPedido('${p}')"><i class="fas fa-times-circle"></i></button>`; listaPedidosEl.appendChild(li); });
  }

  function popularListaFornecedores() {
    listaFornManageEl.innerHTML = '';
    fornecedoresSugeridos.sort().forEach(f => { const li = document.createElement('li'); li.innerHTML = `${f} <button onclick="deletarFornecedor('${f}')"><i class="fas fa-times-circle"></i></button>`; listaFornManageEl.appendChild(li); });
  }

  function formatarDataHora(dataISO) { if (!dataISO) return 'Data inválida'; return new Date(dataISO).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
  function getLinha(nota) { let v = nota.vencimento, o = nota.obs; if (nota.obs === "REMESSA") { v = "REMESSA"; o = "Recurso Proprio Santa Casa"; } return [nota.data, nota.nf, v, nota.valor, "", nota.fornecedor, "", "", o].join("\t"); }
  
  function buildSaidaText() { return notasPendentes.map(getLinha).join("\n"); }
  function toast(msg){ const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block'; clearTimeout(window.__toastTimer); window.__toastTimer = setTimeout(()=> t.style.display='none', 2500); }
  function formatarDataInput(input) { let v = input.value.replace(/\D/g, '').substring(0, 8); if (v.length > 4) v = `${v.slice(0,2)}/${v.slice(2,4)}/${v.slice(4)}`; else if (v.length > 2) v = `${v.slice(0,2)}/${v.slice(2)}`; input.value = v; }
  function formatarValorBlur(event) { const i = event.target; let v = i.value.replace(/\./g, '').replace(',', '.').replace(/[^\d.]/g, ''); if (v === '' || isNaN(v)) return; i.value = parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

  function gerarHtmlChecklist(nota) {
      let html = '';
      const checklistData = nota.checklist || {};
      for (const key in checklistDefinition) {
          const isChecked = checklistData[key] ? 'checked' : '';
          html += `
              <div class="checklist-item">
                  <input type="checkbox" id="check-${key}-${nota.id}" ${isChecked} onchange="atualizarChecklist('${nota.id}', '${key}', this.checked)">
                  <label for="check-${key}-${nota.id}">${checklistDefinition[key]}</label>
              </div>
          `;
      }
      return html;
  }

  function rebuildNotasPendentesList(pagina = 1) {
    listaNotasPendentes.innerHTML = ''; paginaAtualNotas = pagina;
    if (notasPendentes.length === 0) {
        listaNotasPendentes.innerHTML = `<li class="nota-item">Nenhuma nota para gerenciar.</li>`;
        paginacaoNotasEl.innerHTML = '';
    } else {
        const inicio = (pagina - 1) * itensPorPagina, fim = inicio + itensPorPagina;
        notasPendentes.slice(inicio, fim).forEach((nota, index) => {
          const gIndex = inicio + index, li = document.createElement('li');
          li.className = `nota-item ${nota.enviada ? 'nota-enviada' : ''}`; li.dataset.noteId = nota.id;
          
          let actHTML = '';
          if (nota.enviada) actHTML = `<button class="sent-btn icon-only" title="Fotos Enviadas"><i class="fas fa-check"></i></button>`;
          else if (nota.fotos && nota.fotos.length > 0) actHTML = `<button class="whatsapp-btn icon-only" onclick="compartilharNota(${gIndex})" title="Compartilhar"><i class="fab fa-whatsapp"></i></button>`;
          else actHTML = `<span class="sem-fotos">SEM FOTOS</span>`;

          const totalTasks = Object.keys(checklistDefinition).length;
          const completedTasks = nota.checklist ? Object.values(nota.checklist).filter(Boolean).length : 0;
          const progressPercent = (completedTasks / totalTasks) * 100;
          
          li.innerHTML = `
            <div class="nota-info"><b>${nota.fornecedor} ${nota.nf || ''}</b></div>
            <div class="nota-data">Criada em: ${formatarDataHora(nota.dataCriacao)}</div>
            <div class="nota-detalhes">Venc: ${nota.vencimento||'N/A'} | Valor: ${nota.valor||'N/A'} ${nota.obs ? `| Obs: ${nota.obs}`:''}</div>
            <div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>
            <div class="actions-row">
              <div class="actions-group">
                 <button onclick="toggleChecklist(this, '${nota.id}')">Progresso: ${completedTasks}/${totalTasks}</button>
              </div>
              <div class="actions-group">
                ${actHTML}
                <button class="edit-btn icon-only" onclick="toggleEditPanel(this)" title="Editar"><i class="fas fa-pen"></i></button>
                <button class="delete-btn icon-only" onclick="deletarNota(${gIndex})" title="Excluir"><i class="fas fa-trash"></i></button>
              </div>
            </div>
            <div class="edit-panel">
              <div class="edit-fields-row"><div class="campo"><label>Fornecedor</label><input type="text" id="fornEdit-${gIndex}" value="${nota.fornecedor||''}" oninput="this.value=this.value.toUpperCase()"></div><div class="campo"><label>NF</label><input type="text" id="nfEdit-${gIndex}" value="${nota.nf||''}"></div><div class="campo"><label>Vencimento</label><input type="text" id="vencEdit-${gIndex}" value="${nota.vencimento||''}" oninput="formatarDataInput(this)"></div></div>
              <div class="edit-fields-row"><div class="campo" style="flex:1;"><label>Valor</label><input type="text" id="valorEdit-${gIndex}" value="${nota.valor||''}" onblur="formatarValorBlur(event)"></div><div class="campo" style="flex:1;"><label>Observações</label><select id="obsEdit-${gIndex}"></select></div></div>
              <div class="campo fotos-edit-container-${gIndex}"></div>
              <div class="actions"><button style="background:var(--button-success);color:#fff;flex:1;" onclick="salvarEdicao(${gIndex})"><i class="fas fa-save"></i> Salvar</button></div>
            </div>
            <div class="checklist-container">${gerarHtmlChecklist(nota)}</div>`;
          listaNotasPendentes.appendChild(li);

          if (idPainelEdicaoAberto === nota.id) li.querySelector('.edit-panel').classList.add('show');
          if (openChecklistIds.has(nota.id)) { li.querySelector('.checklist-container').style.display = 'block'; }
          
          const obsSelectEdit = li.querySelector(`#obsEdit-${gIndex}`);
          obsSelectEdit.innerHTML = '<option value="">Recurso a ser pago</option>';
          observacoesSugeridas.forEach(obs => obsSelectEdit.innerHTML += `<option value="${obs}">${obs}</option>`);
          obsSelectEdit.value = nota.obs || '';
          reconstruirPainelFotosEdit(gIndex);
        });
    }
    saidaEl.value = buildSaidaText();
  }


  async function reconstruirPainelFotosEdit(gIndex) {
      const container = document.querySelector(`.fotos-edit-container-${gIndex}`), nota = notasPendentes[gIndex];
      if (nota.enviada) { container.innerHTML = `<div class="fotos-enviadas-status"><i class="fas fa-check-circle"></i> Fotos já enviadas!</div>`; return; }
      container.innerHTML = `<label>Anexar/Remover Fotos</label><label for="edit-fotos-${gIndex}" class="file-input-label"><i class="fas fa-camera"></i> Adicionar Imagens</label><input type="file" id="edit-fotos-${gIndex}" class="edit-file-input" multiple accept="image/*" /><div class="miniaturas-container-edit" id="miniaturas-container-edit-${gIndex}"></div><div class="hint">${nota.fotos&&nota.fotos.length>0?`${nota.fotos.length} foto(s) anexada(s).`:'Nenhuma foto anexada.'}</div>`;
      container.querySelector(`#edit-fotos-${gIndex}`).addEventListener('change', async e => {
          if (e.target.files.length === 0) return;
          idPainelEdicaoAberto = nota.id;
          const newIds = await Promise.all(Array.from(e.target.files).map(f => savePhotoDB(generateUniqueId(), f)));
          await notasCollection.doc(nota.id).update({ fotos: [...(nota.fotos || []), ...newIds] });
          toast(`${e.target.files.length} foto(s) adicionada(s).`);
      });
      reconstruirMiniaturasEdit(gIndex);
  }
  
  async function reconstruirMiniaturasEdit(gIndex) {
    const container = document.getElementById(`miniaturas-container-edit-${gIndex}`), nota = notasPendentes[gIndex];
    if (!container || !nota.fotos || nota.fotos.length === 0) { if(container) container.innerHTML = ''; return; }
    container.innerHTML = '';
    const files = await Promise.all(nota.fotos.map(id => getPhotoDB(id).catch(() => null)));
    nota.fotos.forEach((photoId, i) => {
        const file = files[i], wrapper = document.createElement('div');
        wrapper.className = 'miniatura-wrapper';
        if (file) {
            const img = document.createElement('img'), btn = document.createElement('button');
            img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src);
            img.onclick = () => { const validFiles = files.filter(f=>f); abrirPreview(validFiles, validFiles.indexOf(file), gIndex); };
            btn.className = 'remove-foto'; btn.innerHTML = '×';
            btn.onclick = e => { e.stopPropagation(); removerFotoEdit(gIndex, i); };
            wrapper.append(img, btn);
        } else { wrapper.innerHTML = `<div class="not-found"><i class="fas fa-cloud"></i>Por aí…</div>`; }
        container.appendChild(wrapper);
    });
  }

  function popularListaHistorico() {
    listaHistoricoEl.innerHTML = '';
    if (historicoNotas.length === 0) { listaHistoricoEl.innerHTML = `<li class="nota-item">O histórico está vazio.</li>`; return; }
    historicoNotas.forEach(nota => { const li = document.createElement('li'); li.classList.add('nota-item'); li.innerHTML = `<div class="nota-info"><b>${nota.fornecedor} - ${nota.nf||'N/A'}</b></div><div class="historico-detalhes">Movido para histórico em: ${nota.dataHistorico}</div>`; listaHistoricoEl.appendChild(li); });
  }

  async function limparHistorico() { if (historicoNotas.length === 0) return toast("Histórico já está vazio."); if (confirm("Tem certeza que deseja apagar todo o histórico de notas? Essa ação é irreversível.")) { const batch = firestore.batch(); historicoNotas.forEach(n => batch.delete(historicoCollection.doc(n.id))); await batch.commit(); toast("Histórico limpo com sucesso!"); } }
  async function removerFotoEdit(gIndex, fIndex) { if (!confirm("Remover esta imagem da nota?")) return; const nota = notasPendentes[gIndex]; idPainelEdicaoAberto = nota.id; const photoId = nota.fotos[fIndex], updatedIds = nota.fotos.filter((_, i) => i !== fIndex); await notasCollection.doc(nota.id).update({ fotos: updatedIds }); await deletePhotoDB(photoId); toast("Imagem removida."); }
  function togglePopup(id) { const p = document.getElementById(id); if (p.style.display === 'flex') closePopup(id); else openPopup(id); }
  function openPopup(id) { document.body.classList.add('popup-open'); popups.forEach(p => p.style.display = 'none'); document.getElementById(id).style.display = 'flex'; if (id === 'fornecedores-popup') popularListaFornecedores(); else if (id === 'pedidos-popup') popularListaPedidos(); else if (id === 'observacoes-popup') popularObservacoesList(); }
  function closePopup(id) { document.getElementById(id).style.display = 'none'; document.body.classList.remove('popup-open'); }
  
  function toggleEditPanel(btn) {
      const notaItem = btn.closest('.nota-item');
      const editPanel = notaItem.querySelector('.edit-panel');
      const checklistContainer = notaItem.querySelector('.checklist-container');
      const notaId = notaItem.dataset.noteId;
      const isEditPanelVisible = editPanel.classList.contains('show');

      if (isEditPanelVisible) {
          editPanel.classList.remove('show');
          if (idPainelEdicaoAberto === notaId) idPainelEdicaoAberto = null;
      } else {
          editPanel.classList.add('show');
          idPainelEdicaoAberto = notaId;
          if (openChecklistIds.has(notaId)) {
              openChecklistIds.delete(notaId);
              checklistContainer.style.display = 'none';
          }
      }
  }

  function toggleChecklist(btn, notaId) {
      const notaItem = btn.closest('.nota-item');
      const checklistContainer = notaItem.querySelector('.checklist-container');
      const editPanel = notaItem.querySelector('.edit-panel');
      const isChecklistVisible = openChecklistIds.has(notaId);

      if (isChecklistVisible) {
          openChecklistIds.delete(notaId);
          checklistContainer.style.display = 'none';
      } else {
          openChecklistIds.add(notaId);
          checklistContainer.style.display = 'block';
          if (editPanel.classList.contains('show')) {
              editPanel.classList.remove('show');
              if (idPainelEdicaoAberto === notaId) idPainelEdicaoAberto = null;
          }
      }
  }

  function atualizarChecklist(notaId, tarefa, isChecked) {
      isChecklistUpdate = true; // Ativa a flag para o listener ignorar o redesenho
      const updateData = {};
      updateData[`checklist.${tarefa}`] = isChecked;
      
      notasCollection.doc(notaId).update(updateData).catch(error => {
          console.error("Erro ao atualizar checklist:", error);
          toast("Erro ao salvar progresso.");
      });

      const nota = notasPendentes.find(n => n.id === notaId);
      if (!nota) return;
      if (!nota.checklist) nota.checklist = {};
      nota.checklist[tarefa] = isChecked;

      const totalTasks = Object.keys(checklistDefinition).length;
      const completedTasks = Object.values(nota.checklist).filter(Boolean).length;
      const progressPercent = (completedTasks / totalTasks) * 100;

      const notaItemEl = document.querySelector(`li[data-note-id="${notaId}"]`);
      if (notaItemEl) {
          const progressBar = notaItemEl.querySelector('.progress-bar');
          const progressButton = notaItemEl.querySelector('.actions-group button');
          if (progressBar) progressBar.style.width = `${progressPercent}%`;
          if (progressButton) progressButton.textContent = `Progresso: ${completedTasks}/${totalTasks}`;
      }
  }

  async function salvarEdicao(gIndex) {
    const nota = notasPendentes[gIndex];
    const data = { fornecedor: document.getElementById(`fornEdit-${gIndex}`).value.trim().toUpperCase(), nf: document.getElementById(`nfEdit-${gIndex}`).value.trim(), vencimento: document.getElementById(`vencEdit-${gIndex}`).value.trim(), valor: document.getElementById(`valorEdit-${gIndex}`).value.trim(), obs: document.getElementById(`obsEdit-${gIndex}`).value.trim() };
    await notasCollection.doc(nota.id).update(data);
    adicionarFornecedor(data.fornecedor); toast('✓ Nota editada e salva!');
    toggleEditPanel(document.querySelector(`li[data-note-id="${nota.id}"] .edit-btn`));
  }

  async function deletarNota(index) { if (confirm("Tem certeza que deseja excluir esta nota?")) { const nota = notasPendentes[index]; await notasCollection.doc(nota.id).delete(); if (nota.fotos && nota.fotos.length > 0) await Promise.all(nota.fotos.map(id => deletePhotoDB(id))); toast("🗑️ Nota excluída!"); } }
  
  async function exportar() {
    if (saidaEl.value === "") return toast("Nada para copiar. A lista está vazia.");
    await navigator.clipboard.writeText(saidaEl.value);
    toast("✓ Linhas copiadas! Agora é só colar no Excel.");
  }

  async function limpar() {
    if (notasPendentes.length === 0) return toast("Nenhuma nota para limpar.");
    if (!confirm(`Mover ${notasPendentes.length} nota(s) para o histórico? As fotos serão excluídas.`)) return;
    const batch = firestore.batch();
    for (const nota of notasPendentes) {
        batch.set(historicoCollection.doc(), { fornecedor: nota.fornecedor, nf: nota.nf, dataHistorico: formatarDataHora(new Date().toISOString()) });
        batch.delete(notasCollection.doc(nota.id));
        if (nota.fotos && nota.fotos.length > 0) await Promise.all(nota.fotos.map(id => deletePhotoDB(id)));
    }
    await batch.commit();
    limparFormularioPrincipal();
    toast("Notas movidas para o histórico.");
  }

  async function gerarImagemSeparadora(fornecedor, nf) { const c = document.createElement('canvas'); c.width=600; c.height=150; const ctx=c.getContext('2d'); ctx.fillStyle='#34495e'; ctx.fillRect(0,0,600,150); ctx.fillStyle='#ecf0f1'; ctx.font='bold 30px -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, sans-serif'; ctx.textAlign='center'; ctx.fillText(`${fornecedor} ${nf}`,300,70); ctx.font='50px sans-serif'; ctx.fillText(`↓`,300,130); return new Promise(r=>c.toBlob(r,'image/png')); }
  async function compartilharNota(index) {
    const nota = notasPendentes[index];
    if (nota.enviada) return toast("Esta nota já foi enviada.");
    if (!navigator.share) return toast("Compartilhamento não suportado.");
    try {
        toast("Preparando fotos...");
        const files = await Promise.all((nota.fotos || []).map(id => getPhotoDB(id)));
        const validFiles = files.filter(f => f), separador = await gerarImagemSeparadora(nota.fornecedor, nota.nf);
        const filesToShare = [new File([separador], 'separador.png', { type: 'image/png' }), ...validFiles];
        await navigator.share({ files: filesToShare, text: `${nota.fornecedor} ${nota.nf || ''}` });
        await Promise.all((nota.fotos || []).map(id => deletePhotoDB(id)));
        await notasCollection.doc(nota.id).update({ enviada: true, fotos: [] });
        toast("✓ Nota compartilhada e fotos locais removidas!");
    } catch (error) { if (error.name !== 'AbortError') { console.error('Erro ao compartilhar:', error); toast("Erro ao compartilhar."); } }
  }

  async function compartilharLista() {
    const texto = saidaEl.value;
    if (!texto.trim()) return toast("Nada para compartilhar.");
    if (navigator.share) {
        try { await navigator.share({ title: 'Relação de Notas Fiscais', text: texto }); toast("Lista compartilhada!"); }
        catch (err) { if (err.name !== 'AbortError') toast("Erro ao compartilhar."); }
    } else { await navigator.clipboard.writeText(texto); toast("Compartilhamento não suportado. Lista copiada!"); }
  }

  function adicionarPedido() { const pNum = pedidoNumInput.value.trim(), r = pedidoRecursoSelect.value; if (pNum && r) { pedidosRecursos[pNum] = r; salvarEstado(); popularListaPedidos(); pedidoNumInput.value = ''; pedidoRecursoSelect.value = ''; toast(`Pedido ${pNum} associado a ${r}!`); } else { toast('Preencha o pedido e o recurso.'); } }
  function deletarPedido(p) { if (confirm(`Excluir o pedido ${p}?`)) { delete pedidosRecursos[p]; salvarEstado(); popularListaPedidos(); toast(`Pedido ${p} excluído.`); } }
  function adicionarFornecedorManage() { const f = fornManageInput.value.trim(); if (f) { adicionarFornecedor(f); popularListaFornecedores(); fornManageInput.value = ''; toast(`Fornecedor ${f.toUpperCase()} adicionado!`); } }
  function deletarFornecedor(f) { if (confirm(`Excluir o fornecedor ${f}?`)) { fornecedoresSugeridos = fornecedoresSugeridos.filter(i => i !== f); salvarEstado(); popularDatalist(fornDatalist); popularListaFornecedores(); toast(`Fornecedor ${f} excluído.`); } }
  function adicionarObservacaoManage() { const o = obsManageInput.value.trim(); if (o) { adicionarObservacao(o); obsManageInput.value = ''; toast(`Observação "${o}" adicionada!`); } }
  function deletarObservacao(o) { if (confirm(`Excluir a observação "${o}"?`)) { observacoesSugeridas = observacoesSugeridas.filter(i => i !== o); salvarEstado(); popularObservacoesList(); toast(`Observação "${o}" excluída.`); } }

  function removerFotoAcumulada(index) { fotosAcumuladas.splice(index, 1); reconstruirMiniaturasAcumuladas(); }
  function reconstruirMiniaturasAcumuladas() {
      miniaturasContainer.innerHTML = ''; fileCountHintEl.textContent = `${fotosAcumuladas.length} imagem(ns) acumulada(s).`;
      fileLabelEl.classList.toggle('active', fotosAcumuladas.length > 0);
      fotosAcumuladas.forEach((file, i) => {
        const w = document.createElement('div'), img = document.createElement('img'), btn = document.createElement('button');
        w.className = 'miniatura-wrapper'; img.src = URL.createObjectURL(file); img.onload = () => URL.revokeObjectURL(img.src);
        img.onclick = () => abrirPreview(fotosAcumuladas, i, null); btn.className = 'remove-foto'; btn.innerHTML = '×';
        btn.onclick = e => { e.stopPropagation(); removerFotoAcumulada(i); };
        w.append(img, btn); miniaturasContainer.appendChild(w);
      });
  }

  function abrirPreview(fotos, index, notaIndex) {
    const modal = document.getElementById('modalPreview'), imgPreview = document.getElementById('imgPreview');
    fotoAtualIndex = index; fotoAtualNotaIndex = notaIndex;
    fotoAtualFonte = notaIndex !== null ? 'nota' : 'acumulada'; fotosAtuaisParaPreview = fotos;
    imgPreview.src = URL.createObjectURL(fotos[index]); imgPreview.onload = () => URL.revokeObjectURL(imgPreview.src);
    modal.style.display = 'flex';
    document.getElementById('prevBtn').style.display = index > 0 ? 'block' : 'none';
    document.getElementById('nextBtn').style.display = index < fotos.length - 1 ? 'block' : 'none';
  }

  function fecharPreview() { document.getElementById('modalPreview').style.display = 'none'; fotosAtuaisParaPreview = []; }
  function navegarFotos(dir) { const i = fotoAtualIndex + dir; if (i >= 0 && i < fotosAtuaisParaPreview.length) abrirPreview(fotosAtuaisParaPreview, i, fotoAtualNotaIndex); }
  function salvarFotoPreview() { const l = document.createElement('a'); l.href = document.getElementById('imgPreview').src; l.download = `nota_fiscal_${Date.now()}.png`; l.click(); toast("Imagem salva!"); }

  async function excluirFotoPreview() {
      if (!confirm("Excluir esta imagem?")) return;
      if (fotoAtualFonte === 'acumulada') removerFotoAcumulada(fotoAtualIndex);
      else if (fotoAtualFonte === 'nota') {
          const nota = notasPendentes[fotoAtualNotaIndex]; const fIndex = nota.fotos.findIndex(id => id === fotosAtuaisParaPreview[fotoAtualIndex].id);
          await removerFotoEdit(fotoAtualNotaIndex, fIndex);
      }
      toast("Imagem excluída."); fecharPreview();
  }

  async function salvarNota() {
      const fornecedor = fornEl.value.trim().toUpperCase();
      if (!fornecedor) return toast("O campo 'Nome do Fornecedor' é obrigatório.");
      const salvarBtn = document.getElementById('salvarBtn');
      salvarBtn.disabled = true; salvarBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      try {
          const photoIds = await Promise.all(fotosAcumuladas.map(file => savePhotoDB(generateUniqueId(), file)));
          
          const checklistInicial = {
              tirarFoto: fotosAcumuladas.length > 0,
              entradaSistema: false,
              produtosTransferidos: false,
              fotosNoServidor: false,
              cotacaoNoServidor: false,
              notaEscaneada: false,
              estaNaPlanilha: false,
              cotacaoAnexada: false,
              notaCarimbada: false
          };
          
          await notasCollection.add({ 
              data: dataEl.value.trim(), 
              nf: nfEl.value.trim(), 
              vencimento: vencEl.value.trim(), 
              valor: valorEl.value.trim(), 
              fornecedor, 
              obs: obsEl.value.trim(), 
              fotos: photoIds, 
              enviada: false, 
              dataCriacao: new Date().toISOString(),
              checklist: checklistInicial
          });
          adicionarFornecedor(fornecedor); limparFormularioPrincipal();
          toast("✓ Nota salva!"); window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (e) { console.error("Erro ao salvar nota:", e); toast("✕ Erro ao salvar a nota."); } 
      finally { salvarBtn.disabled = false; salvarBtn.innerHTML = '<i class="fas fa-check"></i> Salvar'; }
  }

  function limparFormularioPrincipal() {
    const today = new Date();
    dataEl.value = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
    [nfEl, vencEl, valorEl, fornEl, obsEl].forEach(el => el.value = "");
    fotosAcumuladas = []; reconstruirMiniaturasAcumuladas(); fotosEl.value = null; nfEl.focus();
  }
  
  function sincronizarManualmente() {
    const btn = document.getElementById('sync-btn');
    btn.classList.add('syncing'); btn.disabled = true;
    toast("Sincronizando com a nuvem...");
    setTimeout(() => { btn.classList.remove('syncing'); btn.disabled = false; toast("Sincronização concluída."); }, 1500);
  }

  document.addEventListener('DOMContentLoaded', () => {
      carregarEstado(); limparFormularioPrincipal();
      document.getElementById('modalPreview').addEventListener('click', e => { if (e.target.id === 'modalPreview') fecharPreview(); });
      popups.forEach(p => p.addEventListener('click', e => { if (e.target.classList.contains('popup-modal')) closePopup(p.id); }));
      ["C/C CTI", "C/C SANTA CASA", "Recurso Proprio Santa Casa", "Recurso Proprio CTI", "PAGO", "REMESSA"].forEach(obs => adicionarObservacao(obs));
      nfEl.focus();
      dataEl.addEventListener('input', () => formatarDataInput(dataEl));
      vencEl.addEventListener('input', () => formatarDataInput(vencEl));
      valorEl.addEventListener('blur', formatarValorBlur);
  });

  [fornEl, fornManageInput].forEach(el => el.addEventListener('input', () => el.value = el.value.toUpperCase()));
  fornManageInput.addEventListener('keydown', e => e.key === 'Enter' && adicionarFornecedorManage());
  obsManageInput.addEventListener('keydown', e => e.key === 'Enter' && adicionarObservacaoManage());

  fotosEl.addEventListener('change', e => { fotosAcumuladas.push(...Array.from(e.target.files)); reconstruirMiniaturasAcumuladas(); e.target.value = null; });

  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT')) {
      e.preventDefault();
      const ordem = [dataEl, nfEl, vencEl, valorEl, fornEl, obsEl];
      const idx = ordem.indexOf(e.target);
      if (idx > -1 && idx < ordem.length - 1) {
        if (e.target === dataEl) vencEl.value = dataEl.value;
        ordem[idx + 1].focus();
      } else if (e.target === obsEl) {
        salvarNota();
      }
    }
  });
</script>
</body>
</html>
